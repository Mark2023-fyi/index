<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario: Austin a Medell√≠n</title>
    <style>
        /* --- General & Glassmorphism Style Update --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap');
        :root {
            --brand-red: #CF4647;
            --brand-blue: #007bff;
            --brand-green: #28a745;
            --gemini-purple: #8E44AD;
        }
        body{
            font-family:'Poppins',sans-serif;
            background-color: #f0f2f5;
            color:#2c3e50;
            margin:0;
            padding:20px; 
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .lava-lamp-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: linear-gradient(120deg, #e0f2f7 0%, #ebedee 100%); }
        .lava-lamp-background .blob { position: absolute; border-radius: 50%; filter: blur(40px); opacity: 0.6; }
        .blob:nth-child(1) { width: 400px; height: 400px; background: #89CFF0; animation: move 25s infinite alternate; }
        .blob:nth-child(2) { width: 300px; height: 300px; background: #ADD8E6; animation: move 30s infinite alternate-reverse; }
        .blob:nth-child(3) { width: 250px; height: 250px; background: #B0E0E6; animation: move 20s infinite alternate; }
        @keyframes move { from { transform: translate(-100px, -50px) rotate(-90deg); } to { transform: translate(100vw, 50vh) rotate(90deg); } }

        /* --- Pre-Screen Styles (with glass effect) --- */
        #pre-screen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 10000; display: flex; justify-content: center; align-items: center; transition: opacity 0.7s ease; }
        #pre-screen-overlay.hidden { opacity: 0; pointer-events: none; }
        .pre-screen-content { 
            display: flex; flex-direction: column; align-items: center; gap: 40px; padding: 30px;
            background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);
            max-width: 500px; margin: 20px; box-sizing: border-box; 
        }
        .pre-screen-text { text-align: center; color: #2c3e50; }
        .pre-screen-text h2 { color: var(--brand-red); margin-top: 0; }
        .pre-screen-text p { font-size: 1.1em; max-width: 400px; margin: 0 auto; line-height: 1.6; }
        .loader { height: 60px; aspect-ratio: 2; border-bottom: 3px solid #0000; background: linear-gradient(90deg,#555 50%,#0000 0) -25% 100%/50% 3px repeat-x border-box; position: relative; animation: l3-0 .75s linear infinite; }
        .loader:before { content: ""; position: absolute; inset: auto 42.5% 0; aspect-ratio: 1; border-radius: 50%; background: var(--brand-red); animation: l3-1 .75s cubic-bezier(0,900,1,900) infinite; }
        @keyframes l3-0 { to {background-position: -125% 100%} }
        @keyframes l3-1 { 0%,2% {bottom: 0%} 98%,to {bottom:.1%} }
        .enter-button { font-family: 'Poppins', sans-serif; background-color: var(--brand-blue); color: white; border: none; border-radius: 8px; padding: 12px 30px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .enter-button:hover { background-color: #0056b3; transform: scale(1.05); }

        /* --- Main App Styles --- */
        .container{max-width:800px;margin:0 auto; transition: max-width 0.3s ease, padding 0.3s ease;}h1,h2,h3{text-align:center;color:#1c2a39}h1{font-size:2.2em;margin-bottom:15px;text-shadow: 0 1px 3px rgba(0,0,0,0.1);}h2{font-size:1.5em;margin:40px 0 20px;color:var(--brand-blue)}
        .status-bar, .countdown-card, .item-content, .info-card, .weather-widget, #chat-view-wrapper, .how-to-banner {
            background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);
        }
        .status-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;padding:8px 15px;font-size:0.85em;margin-bottom:15px;gap:15px;}
        .live-status{display:flex;align-items:center;gap:8px;font-weight:600;color:#d9534f;}
        .update-details{display:flex;align-items:center;gap:10px;flex-grow:1;justify-content:flex-end;}
        .last-update{color:#333;text-align:right;}
        .notification-chip{color:white;padding:5px 12px;border-radius:16px;font-weight:600;display:flex;align-items:center;gap:5px;white-space:nowrap;}
        .notification-chip.timeline-update { background-color: var(--brand-green); }
        .notification-chip.chat-update { background-color: var(--brand-blue); }
        .how-to-banner{padding:15px 20px;margin-bottom:30px;position:relative;display:none;}
        .how-to-banner h4{margin:0 0 10px 0;color:#0d47a1;text-align:left;}
        .how-to-banner p{margin:0 0 10px 0;font-size:0.9em;line-height:1.6;text-align:left;}
        .dismiss-banner-btn{background:none;border:none;color:#555;text-decoration:underline;font-size:0.8em;cursor:pointer;padding:5px;margin-top:5px;display:block;}
        .dismiss-banner-btn:hover{color:#0d47a1;}
        .icon-inline{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle;margin:0 2px;}
        .add-button-demo{background-color:var(--brand-blue);color:white;border-radius:50%;width:18px;height:18px;font-size:14px;font-weight:bold;line-height:18px;text-align:center;}
        .notification-badge-demo{background-color:#ff4d4d;color:white;border-radius:50%;min-width:18px;height:18px;padding:0 3px;font-size:12px;line-height:18px;text-align:center;font-weight:bold;}
        .reply-counter-badge-demo{background-color:var(--brand-green);color:white;border-radius:4px;padding:1px 5px;font-size:11px;font-weight:bold;}
        .countdown-container{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;gap:15px;margin-bottom:15px}
        .countdown-card{color:#1c2a39;padding:20px;text-align:center;flex:1;min-width:280px;min-height:105px;display:flex;flex-direction:column;justify-content:center;}
        .countdown-card h3{margin-top:0;margin-bottom:10px;font-size:1.1em;font-weight:400;color:var(--brand-blue)}.countdown-card .arrival-date{margin:-5px 0 15px 0;font-size:0.85em;color:#333;opacity:0.9}.timer{display:flex;justify-content:center;gap:15px;font-family:'Roboto Mono',monospace}.time-block{display:flex;flex-direction:column;min-width:55px}.time-block span:first-child{font-size:2.2em;font-weight:700;color:#1c2a39;line-height:1}.time-block span:last-child{font-size:.7em;text-transform:uppercase;color:#555}
        .timeline{position:relative;padding:20px 0}.timeline::before{content:'';position:absolute;top:0;left:21px;height:100%;width:4px;background:rgba(255, 255, 255, 0.5)}.timeline-item{padding:10px 20px 10px 65px;position:relative;margin-left:0;margin-bottom:10px}.timeline-item::before{content:attr(data-icon);position:absolute;left:0;top:50%;transform:translateY(-50%);width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.7);border:3px solid var(--brand-blue);text-align:center;line-height:50px;font-size:2.5em; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);}
        .timeline-item.today .item-content { border: 2px solid var(--brand-red); box-shadow: 0 0 15px rgba(207, 70, 71, 0.2); }
        .item-content{padding:15px 20px;}
        .item-date{font-weight:600;color:var(--brand-blue);font-size:1.1em;margin-bottom:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;}.item-date span{flex-grow:1;}.tbd{color:#556;font-style:italic}
        .flight-tracker{border-top:1px solid rgba(255,255,255,0.7);margin-top:15px;padding-top:15px;display:flex;flex-direction:column;gap:10px;align-items:center}
        .flight-tracker h4{margin:0 0 5px 0;font-weight:600;color:#333;display:flex;align-items:center;gap:8px}
        .live-indicator{display:inline-block;width:10px;height:10px;background-color:#ff4d4d;border-radius:50%;animation:blinker 1.5s linear infinite}@keyframes blinker{50%{opacity:0}}.flight-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center}
        .flight-info{display:flex;flex-direction:column;align-items:center}
        .flight-button{display:inline-block;background-color:var(--brand-blue);color:#fff;padding:8px 15px;border-radius:5px;text-decoration:none;font-weight:500;font-size:0.9em;transition:background-color .2s,transform .2s}.flight-button:hover{background-color:#0056b3;transform:translateY(-2px)}
        .flight-route{font-size:0.8em;color:#444;margin-top:4px}
        .info-card{padding:20px;margin-bottom:20px;}
        .info-card h3{margin-top:0;color:var(--brand-blue); display: flex; justify-content: space-between; align-items: center;}.info-card ul{padding-left:0;margin:0; list-style-type: none;}.info-card li{display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.1);}.info-card li:last-child{border-bottom:none;}.info-item-text{flex-grow:1;}
        .weather-widget { padding: 15px 20px; margin-bottom: 15px; }
        .weather-widget h3 { margin: 0 0 15px 0; font-size: 1.2em; color: var(--brand-blue); }
        .weather-locations { display: flex; justify-content: space-around; align-items: center; }
        .weather-location-item { flex: 1; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .weather-city { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; }
        .weather-temp { font-size: 1.3em; font-weight: 600; font-family: 'Roboto Mono', monospace; }
        .weather-time { font-size: 0.9em; color: #333; font-family: 'Roboto Mono', monospace; margin-top: 2px; }
        .weather-divider { width: 1px; background-color: rgba(0,0,0,0.2); align-self: stretch; margin: -5px 10px; }
        .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(240, 240, 245, 0.5);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);}
        .popup-visible{opacity:1!important;visibility:visible!important}
        .popup-content{padding:20px 30px 30px;position:relative;max-width:450px;width:100%;text-align:center;transform:scale(.9);transition:transform .3s; display:flex; flex-direction:column; max-height: 85vh; background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);}
        .popup-visible .popup-content{transform:scale(1)}.popup-content h2{margin-top:0;margin-bottom:15px;flex-shrink:0;}.close-popup{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#555;cursor:pointer;transition:color .2s;z-index:10;}.close-popup:hover{color:#000}
        #modal-date{display:flex;justify-content:space-between;align-items:center;width:100%;gap:15px;padding-right:30px;}
        #modal-events{overflow-y:auto; flex-grow:1; text-align:left;}
        .view-switcher{display:flex;justify-content:center;margin-bottom:30px;background:rgba(255,255,255,0.3);border-radius:10px;padding:5px}
        .view-switcher button{border:none;padding:10px 20px;font-family:'Poppins',sans-serif;font-size:1em;font-weight:600;background:transparent;color:#333;border-radius:8px;cursor:pointer;transition:all .3s ease}
        .view-switcher button.active{background:rgba(255,255,255,0.8);color:var(--brand-blue);box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .view-hidden{display:none}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#ccc;border:1px solid #ccc;border-radius:8px;overflow:hidden}
        .calendar-header{font-weight:600;text-align:center;padding:8px 0;font-size:0.9em;background:rgba(255,255,255,0.4)}
        .calendar-day{background:rgba(255,255,255,0.6);min-height:80px;padding:4px;font-size:0.8em;display:flex;flex-direction:column;position:relative}
        .calendar-day:not(.other-month){cursor:pointer;transition:background .2s}.calendar-day:not(.other-month):hover{background:rgba(241, 248, 255, 0.8)}
        .calendar-day.other-month{background:rgba(249, 249, 249, 0.4);color:#aaa}
        .calendar-day.today { border: 2px solid var(--brand-red); background-color: rgba(255, 235, 238, 0.7); }
        .calendar-day.today .day-number { color: var(--brand-red); font-weight: bold; }
        .calendar-day .day-number{font-weight:600;margin-bottom:5px;text-align:right}
        .event-icons-container{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;padding:0 2px;margin-top:4px}
        .calendar-emoji{font-size:1.6em;line-height:1}
        .item-description{padding-bottom:4px;border-bottom:1px solid rgba(0,0,0,0.1);margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}.item-description:last-child{border-bottom:none;margin-bottom:0;}
        .note-content{flex-grow:1; word-wrap: break-word; word-break: break-word;}.author-name{font-size:0.9em;font-weight:600; display: flex; align-items: center;}
        .item-timestamp{font-size:0.7em; color:#555; white-space:nowrap;}
        .recent-indicator { font-weight: bold; margin-right: 5px; font-size: 0.7em; }
        .recent-indicator.red { color: var(--brand-red); }
        .recent-indicator.green { color: var(--brand-green); }
        #modal-events .item-content{box-shadow:none;padding:10px 0 0 0; background:transparent; border:none; backdrop-filter: none; -webkit-backdrop-filter: none;}
        .modal-close-button{border:none;background:var(--brand-blue);color:#fff;padding:10px 25px;font-size:1em;font-weight:600;border-radius:5px;margin-top:20px;cursor:pointer;transition:background .2s; flex-shrink:0;}.modal-close-button:hover{background:#0056b3}
        .modal-disclaimer{font-size:0.75em; color:#555; margin-top:15px;}
        #add-item-modal .modal-actions { display:flex; gap: 10px; align-items: center; margin-top: 15px;}
        #add-item-modal .modal-actions .modal-close-button { margin-top: 0; flex-grow: 1;}
        .add-button{background-color:var(--brand-blue);color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:16px;font-weight:bold;line-height:24px;cursor:pointer;transition:all .2s;flex-shrink:0;}.add-button:hover{background-color:#0056b3;transform:scale(1.1)}
        #add-item-modal textarea, #add-item-modal select{width:100%;margin-top:10px;padding:10px;border-radius:5px;border:1px solid #ccc;font-family:'Poppins',sans-serif;font-size:1em;box-sizing:border-box}
        #reply-context-container { border: 1px solid rgba(0,0,0,0.1); background: rgba(248, 249, 250, 0.7); border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: left; max-height: 160px; overflow-y: auto; position: relative;}
        #reply-context-container.is-scrollable::after { content: 'Desliza para ver m√°s ‚ñº'; position: sticky; bottom: -10px; display: block; text-align: center; background: linear-gradient(to top, rgba(248, 249, 250, 0.9), rgba(248, 249, 250, 0.9) 70%, transparent); padding-top: 15px; padding-bottom: 10px; font-size: 0.8em; color: #555; font-weight: 600; }
        #reply-context-container h4, #reply-context-container h5 { text-align: left; margin: 0 0 5px 0; font-size: 0.8em; color: #6c757d; text-transform: uppercase; }
        #reply-context-container h5 { margin-top: 10px; }
        .reply-context { border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 8px; }
        .reply-context.original-message { background-color: rgba(233, 236, 239, 0.8); padding: 8px; border-radius: 6px; }
        .reply-context:last-child { border-bottom: none; margin-bottom: 0; }
        .reply-context strong { font-size: 0.9em; }
        .reply-context p { font-size: 0.9em; margin: 4px 0; white-space: pre-wrap; word-wrap: break-word; }
        .reply-context-footer { text-align: right; margin-top: 4px; }
        .reply-context-footer small { font-size: 0.75em; color: #6c757d; display: flex; align-items: center; justify-content: flex-end; }
        .notification-badge{position:absolute;top:4px;left:4px;background-color:#ff4d4d;color:white;border-radius:50%;width:18px;height:18px;font-size:11px;line-height:18px;text-align:center;font-weight:bold;}
        .messages-header{font-weight:600;color:#333;font-size:1em;margin:15px 0 5px 0;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);display:flex;align-items:center;gap:8px;}
        .toggle-visibility-link { background: none; border: none; padding: 8px; margin: 5px auto; display: block; width: fit-content; color: var(--brand-blue); font-weight: 600; font-size: 0.9em; cursor: pointer; text-decoration: none; }
        .toggle-visibility-link:hover { text-decoration: underline; }
        .toggle-text-btn{font-size:0.8em; font-weight:600; color:var(--brand-blue); text-decoration:none; white-space:nowrap; margin-left:5px;}.toggle-text-btn:hover{text-decoration:underline;}
        .note-footer{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 4px;}
        .reply-btn{background:none; border:none; cursor:pointer; font-size:0.75em; color:#444; padding:2px 6px; border-radius:4px; font-weight:600; display:inline-flex; align-items:center; gap:5px; transition: all 0.2s;}.reply-btn:hover{color:var(--brand-blue); background-color: rgba(255,255,255,0.4);}
        .reply-counter-badge{background-color:var(--brand-green);color:white;border-radius:4px;padding:1px 5px;font-size:11px;font-weight:bold;}
        .replies-container{margin-left:20px; padding-left:15px; border-left:2px solid rgba(233, 236, 239, 0.7); margin-top:8px;}
        .reply-block{background:rgba(248, 249, 250, 0.6); border:1px solid rgba(222, 226, 230, 0.7); border-radius:8px; padding:10px; margin-top:8px;}
        .message-number { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; font-size: 0.75em; font-weight: 600; margin-right: 8px; flex-shrink: 0; }
        .message-number.thread { background-color: var(--brand-red); color: white; }
        .message-number.reply { background-color: var(--brand-green); color: white; }
        .weather-forecast{background: rgba(248, 249, 250, 0.6); border:1px solid rgba(222, 226, 230, 0.7); border-radius:8px;padding:8px 12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;font-size:0.9em;}
        .weather-icon{font-size:1.5em;}
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin: 40px 0 10px 0; }
        .chat-header h2 { flex-grow: 1; margin-bottom: 0; }
        .fullscreen-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #888; padding: 0 10px; line-height: 1; transition: color 0.2s, transform 0.2s; }
        .fullscreen-btn:hover { color: #333; transform: scale(1.1); }
        footer{text-align:center;margin-top:40px;font-size:0.8em;color:#333;}
        
        /* --- Birthday & Confetti Styles --- */
        .birthday-banner { background: linear-gradient(45deg, var(--birthday-color-1), var(--birthday-color-2)); color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 1.1em; margin-bottom: 10px; animation: pulse 2s infinite; position: relative; overflow: hidden; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,.08); } 50% { transform: scale(1.03); box-shadow: 0 6px 18px rgba(254, 180, 123, 0.5); } 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,.08); } }
        .calendar-day.birthday-date { background-color: #fff4e6; border: 1px solid var(--birthday-color-2); font-weight: bold; }

        /* --- Chat View Styles (with glass effect) --- */
        #chat-view-wrapper { display: flex; flex-direction: column; height: 70vh; transition: height 0.3s ease; position: relative; overflow:hidden;}
        #chat-messages-container { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: transparent;}
        .chat-date-separator { text-align: center; margin: 15px 0; }
        .chat-date-separator span { background-color: rgba(230, 230, 230, 0.8); color: #555; font-size: 0.8em; font-weight: 600; padding: 4px 12px; border-radius: 12px; }
        .chat-message-container { padding: 0 10px; display: flex; flex-direction: column; margin-bottom: 8px; }
        .chat-message-container.grouped { margin-top: 2px; }
        .chat-message { max-width: 75%; min-width: 80px; padding: 8px 12px; line-height: 1.5; position: relative; word-wrap: break-word; border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); }
        .message-mine { align-self: flex-end; color: #333; background: rgba(220, 248, 198, 0.2); border: 1px solid rgba(220, 248, 198, 0.8); }
        .message-theirs { align-self: flex-start; color: #333; background: rgba(227, 242, 253, 0.2); border: 1px solid rgba(227, 242, 253, 0.8); }
        .chat-author-name { font-size: 0.8em; font-weight: 600; color: #555; margin-bottom: 4px; display: flex; align-items: center; }
        .message-theirs .chat-author-name { color: var(--brand-blue); }
        .avatar { width: 24px; height: 24px; border-radius: 50%; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 8px; font-size: 0.8em; flex-shrink: 0; }
        .bubble-footer { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 2px; height: 16px; }
        .bubble-footer .item-timestamp { color: rgba(0,0,0,0.6); font-size: 0.7em; }
        .bubble-footer .reply-btn { font-size: 0.7em; font-weight: 600; cursor: pointer; background: none; border: none; color: rgba(0,0,0,0.5); padding: 0; opacity: 1; }
        .message-theirs .bubble-footer .reply-btn { color: rgba(0,0,0,0.6); }
        .bubble-footer .reply-btn:hover { color: var(--brand-blue); }
        .chat-input-bar { display: flex; gap: 10px; align-items: center; padding: 10px; background-color: transparent; border-top: 1px solid rgba(255, 255, 255, 0.8); }
        .chat-input-bar select { font-family: 'Poppins', sans-serif; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background-color: #fff; }
        .chat-input-bar textarea { flex-grow: 1; padding: 10px; border-radius: 18px; border: 1px solid #ccc; resize: none; font-family: 'Poppins', sans-serif; font-size: 1em; line-height: 1.4; max-height: 100px; }
        .chat-input-bar button { background-color: var(--brand-blue); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .chat-input-bar button:hover { background-color: #0056b3; }
        .chat-disclaimer { font-size: 0.7em; color: #444; text-align: center; margin-top: 8px; padding: 0 10px; }
        .reply-quote-block { margin: -2px 0 8px 0; padding: 6px 10px; border-radius: 6px; border-left: 3px solid; }
        .reply-quote-author { font-size: 0.8em; font-weight: 600; }
        .reply-quote-text { font-size: 0.85em; opacity: 0.8; margin: 2px 0 0 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-mine .reply-quote-block { background-color: rgba(168, 224, 153, 0.5); border-left-color: #72b863; }
        .message-theirs .reply-quote-block { background-color: rgba(0, 123, 255, 0.1); border-left-color: var(--brand-blue); }
        .message-theirs .reply-quote-author { color: var(--brand-blue); }
        .message-mine .reply-quote-author { color: #1e5513; }
        .chat-sent-indicator { display: flex; align-items: center; gap: 5px; align-self: flex-end; margin-right: 15px; margin-bottom: 5px; font-size: 0.75em; color: #555; opacity: 1; transition: opacity 0.3s ease; }
        .chat-sent-indicator.hidden { opacity: 0; }
        .chat-sent-indicator svg { width: 12px; height: 12px; fill: none; stroke: var(--brand-green); stroke-width: 3; }

        /* --- Fullscreen Chat Styles --- */
        body.fullscreen-chat-active { padding: 0; overflow: hidden; }
        body.fullscreen-chat-active .container { max-width: 100%; width: 100%; height: 100vh; padding: 0; margin: 0; }
        body.fullscreen-chat-active #main-container > *:not(#chat-view) { display: none !important; }
        body.fullscreen-chat-active #chat-view { height: 100%; padding: 0; }
        body.fullscreen-chat-active #chat-view-wrapper { height: 100%; border-radius: 0; border: none; }
        body.fullscreen-chat-active .chat-header { margin-top: 0; padding: 10px 20px; border-radius: 0; }
        body.fullscreen-chat-active #chat-messages-container { padding-bottom: 10px; }

        /* --- Gemini FAB and Overlay Styles --- */
        #gemini-fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--gemini-purple);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
            transition: transform 0.2s ease;
        }
        #gemini-fab:hover {
            transform: scale(1.1);
        }
        #gemini-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 242, 245, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9998;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #gemini-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .gemini-container {
            width: 100%;
            max-width: 700px;
            height: 90%;
            max-height: 800px;
            background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .gemini-container.glowing-effect {
            animation: glow 2.5s ease-out;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 10px rgba(142, 68, 173, 0.2), 0 0 10px rgba(142, 68, 173, 0.2); }
            50% { box-shadow: 0 0 25px rgba(142, 68, 173, 0.7), 0 0 40px rgba(142, 68, 173, 0.5); }
            100% { box-shadow: 0 0 10px rgba(142, 68, 173, 0.2), 0 0 10px rgba(142, 68, 173, 0.2); }
        }
        .gemini-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .gemini-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: var(--gemini-purple);
        }
        #gemini-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .gemini-message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.6;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .gemini-message.user {
            background-color: rgba(227, 242, 253, 0.7);
            margin-left: auto;
        }
        .gemini-message.model {
            background-color: rgba(233, 230, 255, 0.8);
            margin-right: auto;
        }
        .gemini-message .avatar {
            flex-shrink: 0;
        }
        .gemini-message p {
            margin: 0;
        }
        .gemini-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
            margin-top: 15px;
        }
        .gemini-suggestion {
            background: none;
            border: 1px solid var(--gemini-purple);
            color: var(--gemini-purple);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .gemini-suggestion:hover {
            background-color: var(--gemini-purple);
            color: white;
        }
        .gemini-input-bar {
            padding: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .gemini-input-bar textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
        }
        .gemini-input-bar button {
            border: none;
            background-color: var(--gemini-purple);
            color: white;
            border-radius: 8px;
            padding: 0 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- Responsive Styles for Mobile --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8em; }
            .status-bar, .update-details { flex-direction: column; align-items: flex-start; gap: 8px; }
            .update-details { align-items: flex-end; width: 100%; }
            .last-update { font-size: 0.9em; }
            .countdown-container { flex-direction: column; }
            .countdown-card { min-width: 100%; }
            .timeline::before { left: 18px; }
            .timeline-item { padding: 10px 10px 10px 55px; }
            .timeline-item::before { width: 48px; height: 48px; line-height: 42px; font-size: 2em; left: -5px; }
            .item-content { padding: 12px 15px; }
            .popup-content { padding: 20px; max-width: 95%; max-height: 90vh; }
            .view-switcher button { padding: 8px 12px; font-size: 0.9em; }
            .fullscreen-btn { font-size: 1.6em; padding: 5px 10px; }
            
            #gemini-fab { width: 50px; height: 50px; font-size: 1.5em; bottom: 20px; right: 20px; }
            .gemini-container { height: 100%; max-height: 100%; border-radius: 0; }

            /* Chat UX Improvements */
            #chat-view { margin-top: -20px; }
            #chat-view-wrapper { height: 80vh; }
            .chat-message { font-size: 0.95em; }
            .chat-input-bar { flex-wrap: wrap; gap: 5px; }
            .chat-input-bar select { width: 100%; margin-bottom: 5px; order: 1; }
            .chat-input-bar textarea { order: 2; }
            .chat-input-bar button[type="submit"] { order: 3; }
        }

        /* --- Success Indicator Styles --- */
        #success-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--brand-green);
            font-weight: 600;
            font-size: 1.2em;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            background: rgba(220, 255, 220, 0.6);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 167, 69, 0.4);
        }
        #success-indicator.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .checkmark { width: 56px; height: 56px; border-radius: 50%; display: block; stroke-width: 3; stroke: var(--brand-green); stroke-miterlimit: 10; margin: 0 auto; }
        #success-indicator:not(.hidden) .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-linecap: round; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        #success-indicator:not(.hidden) .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards; }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body>
    <div class="lava-lamp-background">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
    </div>

    <div id="success-indicator" class="hidden">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <span>¬°Guardado!</span>
    </div>

    <div id="pre-screen-overlay">
        <div class="pre-screen-content">
            <div class="pre-screen-text">
                <h2>‚ö†Ô∏è ¬°Cuidado!</h2>
                <p>Para uso interno solamente. El link es abierto y cualquiera puede acceder y ver su informaci√≥n.</p>
            </div>
            <div class="loader"></div>
            <button id="enter-button" class="enter-button">S√≠, ingresar</button>
        </div>
    </div>

    <div id="calendar-modal" class="popup-overlay"><div class="popup-content"><span class="close-popup">&times;</span><h2 id="modal-date"></h2><div id="modal-events"></div><button class="modal-close-button">OK</button></div></div>
    
    <div id="add-item-modal" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup">&times;</span>
            <h2 id="add-item-title">A√±adir Entrada</h2>
            <div id="reply-context-container"></div>
            <form id="add-item-form">
                <input type="hidden" id="item-id-input"><input type="hidden" id="item-type-input"><input type="hidden" id="item-date-input"><input type="hidden" id="reply-to-id-input">
                <div id="author-select-container">
                    <select id="author-select" required>
                        <option value="" disabled selected>¬øQui√©n eres?</option>
                        <option value="Anyela">Anyela</option><option value="Nathan">Nathan</option><option value="Yazmin">Yazmin</option><option value="Ron">Ron</option><option value="Yedinson">Yedinson</option><option value="Daniel">Daniel</option>
                    </select>
                </div>
                <textarea id="item-description-input" placeholder="Escribe tu mensaje o nota aqu√≠..."></textarea>
                 <div class="modal-actions">
                    <button type="submit" class="modal-close-button">Guardar</button>
                </div>
                <p class="modal-disclaimer">Los mensajes no se pueden borrar ni editar.</p>
            </form>
        </div>
    </div>

    <div class="container" id="main-container">
    </div>

    <button id="gemini-fab" title="Ask Gemini about the trip">‚ú®</button>
    <div id="gemini-overlay">
        <div class="gemini-container">
            <div class="gemini-header">
                <h2>Preg√∫ntale a Gemini</h2>
                <button class="close-popup" style="position: static; font-size: 2em; line-height: 1;">&times;</button>
            </div>
            <div id="gemini-messages">
                 </div>
            <form id="gemini-form" class="gemini-input-bar">
                <textarea id="gemini-input" placeholder="Pregunta cualquier cosa sobre el viaje..." required></textarea>
                <button type="enviar">Enviar</button>
            </form>
        </div>
    </div>
    
    <footer>Version 090125WG</footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIG & DATA ---
        const GEMINI_API_KEY = "AIzaSyBQUx0uOZsdO3_L7tnd1pkC6a4cMMVvLGw";
        const firebaseConfig = { apiKey: "AIzaSyBQUx0uOZsdO3_L7tnd1pkC6a4cMMVvLGw", authDomain: "itinerario-viaje-cbf9d.firebaseapp.com", databaseURL: "https://itinerario-viaje-cbf9d-default-rtdb.firebaseio.com", projectId: "itinerario-viaje-cbf9d", storageBucket: "itinerario-viaje-cbf9d.appspot.com", messagingSenderId: "88371586960", appId: "1:88371586960:web:8b2dd61a4b7d2bed963515" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const appDataRef = database.ref('appData');
        let appData = {};
        let currentView = 'timeline';
        const defaultAppData = { lastUpdate: { user: "Sistema", time: new Date().toISOString(), type: 'general' }, timelineEvents: { "event-1":{id:"event-1",date:"2025-12-13",icon:"üõ¨",description:"<strong>PM:</strong> LLegada de Nathan a Medellin desde USA.",type:"flight",flightInfo:{title:"Llegada de Nathan",flights:[{num:"CMP716",route:"Austin ‚Üí Panam√°"},{num:"CMP155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-2":{id:"event-2",date:"2025-12-22",icon:"üè†",description:"Regreso de Nathan a Medellin.",type:"flight",flightInfo:{title:"Regreso de Nathan",flights:[{num:"EFY821",route:"Villavicencio ‚Üí Medell√≠n"}]}},"event-3":{id:"event-3",date:"2025-12-24",icon:"üéÑ",description:"Celebraci√≥n de Nochebuena üéÖ",type:"holiday"},"event-4":{id:"event-4",date:"2025-12-25",icon:"üéÅ",description:"D√≠a de Navidad üåü",type:"holiday"},"event-5":{id:"event-5",date:"2025-12-31",icon:"üéâ",description:"Celebraci√≥n de Fin de A√±o ü•Ç",type:"holiday"},"event-6":{id:"event-6",date:"2026-01-01",icon:"ü•Ç",description:"D√≠a de A√±o Nuevo. Descanso. üéâ",type:"holiday"},"event-7":{id:"event-7",date:"2026-01-03",icon:"üõ¨",description:"<strong>PM:</strong> Llegada de Ron y Anyela a Medell√≠n desde USA.",type:"flight",flightInfo:{title:"Llegada de Ron y Anyela",flights:[{num:"CMP716",route:"Austin ‚Üí Panam√°"},{num:"CMP155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-8":{id:"event-8",date:"2026-01-04",icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",description:"Primer encuentro familiar. Almuerzo (hora por definir).",type:"celebration"},"event-9":{id:"event-9",date:"2026-01-12",icon:"üéä",description:"D√≠a en Algeciras (D√≠a Festivo üéä). Planes por determinar.",type:"holiday"},"event-10":{id:"event-10",date:"2026-01-15",icon:"üéÇ",description:"<strong>AM:</strong> Llegada - Bus - De la Familia a Medellin.<br><strong>PM:</strong> Salida y llegada - Vuelo - Ron, Anyela y Nathan para Medellin.",type:"travel"},"event-11":{id:"event-11",date:"2026-01-17",icon:"üõ´",description:"<strong>AM:</strong> Salida del resto del grupo desde Medell√≠n a USA. Fin del viaje.",type:"flight",flightInfo:{title:"Vuelos de Regreso",flights:[{num:"CMP209",route:"Medell√≠n ‚Üí Panam√°"},{num:"CMP715",route:"Panam√° ‚Üí Austin"}]}}}, importantNotes: { "note-101":{id:"note-101",text:"<strong>¬°PRIVADO!</strong> Maria Helena, Yedinson, y Yazmin ya saben."},"note-102":{id:"note-102",text:"Faber, Yisela, y Rosita no saben absolutamente nada."} }, plannedActivities: { "activity-201":{id:"activity-201",text:"Bingo"},"activity-202":{id:"activity-202",text:'Regalos con la letra "V" de un valor de $10,000 pesos'},"activity-203":{id:"activity-203",text:"Scavenger Hunt (B√∫squeda del tesoro)"},"activity-204":{id:"activity-204",text:"Pictionary"} } };
        
        let geminiConversationHistory = [];
        
        // --- WIDGETS ---
        function updateCountdowns() {
            const targets = [ { id: 'card-nathan', date: '2025-12-13T18:00:00', title: 'Llegada de Nathan' }, { id: 'card-ron-anyela', date: '2026-01-03T18:00:00', title: 'Llegada de Ron & Anyela' }];
            targets.forEach(target => { const el=document.getElementById(target.id); if(!el) return; const t=new Date(target.date).getTime(), n=new Date().getTime(), d=t-n; let c=`<h3>${target.title}</h3><div class="arrival-date">${formatAndCapitalizeDate(new Date(target.date))}</div>`; if(d<0) c+="<h4>¬°Ya lleg√≥!</h4>"; else {const s=Math.floor(d/864e5),o=Math.floor(d%864e5/36e5),i=Math.floor(d%36e5/6e4),a=Math.floor(d%6e4/1e3);c+=`<div class="timer"><div class="time-block"><span>${String(s).padStart(2,"0")}</span><span>D√≠as</span></div><div class="time-block"><span>${String(o).padStart(2,"0")}</span><span>Horas</span></div><div class="time-block"><span>${String(i).padStart(2,"0")}</span><span>Min</span></div><div class="time-block"><span>${String(a).padStart(2,"0")}</span><span>Seg</span></div></div>`} el.innerHTML=c });
        }
        
        async function fetchWeather() {
            const locations = [
                { id: 'weather-austin', city: 'Austin', emoji: 'ü§†', lat: 30.27, lon: -97.74, timezone: 'America/Chicago' },
                { id: 'weather-medellin', city: 'Medell√≠n', emoji: 'üá®üá¥', lat: 6.25, lon: -75.56, timezone: 'America/Bogota' },
                { id: 'weather-algeciras', city: 'Algeciras', emoji: 'üèûÔ∏è', lat: 2.52, lon: -75.31, timezone: 'America/Bogota' }
            ];

            for (const loc of locations) {
                const elements = document.querySelectorAll('#' + loc.id);
                if (elements.length === 0) continue;

                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true`);
                    const data = await res.json();
                    const tempC = Math.round(data.current_weather.temperature);
                    const tempF = Math.round(tempC * 9 / 5 + 32);
                    const localTime = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', timeZone: loc.timezone }).replace('p. m.', 'PM').replace('a. m.', 'AM');
                    
                    elements.forEach(el => {
                        if (loc.id === 'weather-algeciras') {
                            el.innerHTML = `<span class="weather-icon">üå°Ô∏è</span> Clima actual en ${loc.city}: <strong>${tempF}¬∞F / ${tempC}¬∞C</strong>`;
                        } else {
                            el.innerHTML = `<div class="weather-city">${loc.emoji} ${loc.city}</div>
                                            <div class="weather-temp">${tempF}¬∞F / ${tempC}¬∞C</div>
                                            <div class="weather-time">${localTime}</div>`;
                        }
                    });
                } catch (error) {
                    console.error("Weather fetch error for " + loc.city, error);
                    elements.forEach(el => el.innerText = `Error clima ${loc.city}.`);
                }
            }
        }

        // --- DATA & RENDER LOGIC ---
        function saveData(user, itemDate = null, updateType = 'general') {
            if(user) appData.lastUpdate = { user, time: new Date().toISOString(), eventDate: itemDate, type: updateType };
            appDataRef.set(appData); 
        }
        appDataRef.on('value', (snapshot) => {
            const data = snapshot.val();
            let loadedData = (data && data.timelineEvents) ? data : JSON.parse(JSON.stringify(defaultAppData));
            if(!loadedData.groupChat) loadedData.groupChat = {};
            appData = loadedData;
            renderApp();
        });

        const dayFormatter = new Intl.DateTimeFormat('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
        const formatAndCapitalizeDate = (date) => {
            const formatted = dayFormatter.format(date);
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
        
        function handleBannerVisibility() {
            const banner = document.getElementById('how-to-banner');
            if (banner && localStorage.getItem('itineraryBannerDismissed') !== 'true') {
                banner.style.display = 'block';
            }
        }

        function truncateText(html, charLimit = 150) {
            html = html || '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const textContent = tempDiv.textContent || tempDiv.innerText || "";

            if (textContent.length <= charLimit) {
                return html;
            }
            const visibleText = html.substring(0, charLimit);
            const hiddenText = html.substring(charLimit);
            return `<span>${visibleText}</span><span class="ellipsis">... </span><span class="more-text" style="display:none;">${hiddenText}</span> <a href="#" class="toggle-text-btn">Ver m√°s</a>`;
        }

        const AVATAR_COLORS = ['#E53935', '#D81B60', '#5E35B1', '#3949AB', '#1E88E5', '#039BE5', '#00ACC1', '#00897B', '#43A047', '#7CB342', '#F4511E', '#795548', '#546E7A'];
        const getInitials = (name) => {
            if (!name) return '';
            if (name === 'Gemini') return '‚ú®';
            const names = name.split(' ');
            if (names.length > 1 && names[1]) {
                return (names[0].charAt(0) + names[1].charAt(0)).toUpperCase();
            }
            return name.charAt(0).toUpperCase();
        };

        const generateColor = (name) => {
            if (name === 'Gemini') return 'var(--gemini-purple)';
            let hash = 0;
            if (!name || name.length === 0) return AVATAR_COLORS[0];
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % AVATAR_COLORS.length;
            return AVATAR_COLORS[index];
        };
        
        function renderApp() {
            const isChatFullscreen = document.body.classList.contains('fullscreen-chat-active');
            
            document.getElementById('main-container').innerHTML = getBaseHTML();
            renderTimeline(); 
            renderCalendar(); 
            renderChat();
            renderInfoLists();
            attachDynamicListeners();
            updateHeader();
            updateCountdowns();
            fetchWeather();
            handleBannerVisibility();
            
            if (currentView === 'chat' && isChatFullscreen) {
                switchView('chat', false);
            } else {
                switchView(currentView, true);
            }
        }

        function renderMessageThreadsListHTML(messages, options = {}) {
            if (messages.length === 0) return '';
            const notesById = {};
            messages.forEach(note => { notesById[note.id] = { ...note, replies: [] }; });
            const allMessageThreads = [];
            messages.forEach(note => {
                if (note.replyingTo && notesById[note.replyingTo]) {
                    notesById[note.replyingTo].replies.push(notesById[note.id]);
                } else {
                    allMessageThreads.push(notesById[note.id]);
                }
            });
            
            const threadsOldestFirst = [...allMessageThreads].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            const threadNumberMap = new Map(threadsOldestFirst.map((thread, index) => [thread.id, index + 1]));

            const messageThreads = allMessageThreads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '';
            const collapseAfter = options.collapseAfter || messageThreads.length;

            const renderAndTrack = (threads) => {
                let tempHtml = '';
                threads.forEach(thread => {
                    tempHtml += renderSingleThread(thread, threadNumberMap.get(thread.id), { ...options });
                });
                return tempHtml;
            };

            html += renderAndTrack(messageThreads.slice(0, collapseAfter));

            if (messageThreads.length > collapseAfter) {
                let hiddenHtml = renderAndTrack(messageThreads.slice(collapseAfter));
                html += `<div class="collapsible-messages" style="display:none;">${hiddenHtml}</div>`;
                html += `<button class="toggle-visibility-link" data-count="${messageThreads.length - collapseAfter}">Ver ${messageThreads.length - collapseAfter} mensajes anteriores</button>`;
            }
            return html;
        }

        function renderSingleThread(thread, threadNumber, options) {
            let mostRecentInThreadId = null;
            if (thread.replies.length > 0) {
                const latestReply = [...thread.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                mostRecentInThreadId = latestReply.id;
            }
            options.mostRecentInThreadId = mostRecentInThreadId;

            let threadHtml = renderMessage(thread, threadNumber, false, options);
            if (thread.replies.length > 0) {
                threadHtml += `<h4 class="messages-header" style="margin-top: 10px; padding-top: 10px; font-size: 0.9em;">Comentarios:</h4>`;
                threadHtml += `<div class="replies-container">`;
                const repliesOldestFirst = [...thread.replies].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const replyNumberMap = new Map(repliesOldestFirst.map((reply, index) => [reply.id, index + 1]));
                const repliesNewestFirst = [...thread.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                let lastReplyAuthor = thread.author;
                repliesNewestFirst.forEach((reply) => { 
                    const showAuthor = reply.author !== lastReplyAuthor;
                    const replyNumber = replyNumberMap.get(reply.id);
                    threadHtml += renderMessage(reply, replyNumber, true, { ...options, showAuthor });
                    lastReplyAuthor = reply.author;
                });
                threadHtml += `</div>`;
            }
            threadHtml += `</div>`;
            return threadHtml;
        }

        function renderMessage(note, number, isReply, options = {}) {
            const numberClass = isReply ? 'reply' : 'thread';
            const numberHtml = `<span class="message-number ${numberClass}">${number}</span>`;
            const authorHtml = `<strong class="author-name">${note.author}:</strong>`;
            
            let nuevoIndicator = '';
            if (note.id === options.mostRecentId && !isReply) {
                nuevoIndicator = `<strong class="recent-indicator red">NUEVO</strong>`;
            } else if (isReply && note.id === options.mostRecentInThreadId) {
                nuevoIndicator = `<strong class="recent-indicator green">M√ÅS RECIENTE</strong>`;
            }
            
            const timestampHtml = `<span class="item-timestamp">${nuevoIndicator} ${new Date(note.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit', timeZone: 'America/Bogota'}).replace('.', '')} COL</span>`;
            const replyCounter = !isReply && note.replies && note.replies.length > 0 ? `<span class="reply-counter-badge">${note.replies.length}</span>` : '';
            let footerHtml = `<div class="note-footer">${timestampHtml}`;
            if(!isReply) {
                footerHtml += `<button class="reply-btn" data-type="${options.dataType}" data-reply-to-id="${note.id}" ${note.date ? `data-date="${note.date}"` : ''}>Responder${replyCounter}</button>`;
            }
            footerHtml += `</div>`;
            
            const authorLine = `<div class="author-name">${numberHtml} ${authorHtml}</div>`;
            const messageContent = `<div class="note-content">${authorLine}${truncateText(note.text)}${footerHtml}</div>`;

            if(isReply) {
                return `<div class="reply-block">${messageContent}</div>`;
            } else {
                return `<div class="item-content"><div class="item-description">${messageContent}</div>`;
            }
        }

        function getDisplayDate(messageDate) {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            const opts = { timeZone: 'America/Bogota' };
            if (messageDate.toLocaleDateString('es-CO', opts) === today.toLocaleDateString('es-CO', opts)) {
                return "Hoy";
            }
            if (messageDate.toLocaleDateString('es-CO', opts) === yesterday.toLocaleDateString('es-CO', opts)) {
                return "Ayer";
            }
            return messageDate.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Bogota' });
        }
        
        function renderMessageBubblesHTML(messages, options = {}) {
            let html = '';
            let lastDisplayDate = null;
            let lastAuthor = null;

            messages.forEach(note => {
                const messageDate = new Date(note.timestamp);
                const displayDate = getDisplayDate(messageDate);

                if (displayDate !== lastDisplayDate) {
                    html += `<div class="chat-date-separator"><span>${displayDate}</span></div>`;
                    lastDisplayDate = displayDate;
                    lastAuthor = null; 
                }
                
                const showAuthor = note.author !== lastAuthor;
                html += renderBubble(note, showAuthor, options);
                lastAuthor = note.author;
            });
            return html;
        }

        function renderBubble(note, showAuthor, options) {
            const currentUser = localStorage.getItem('itineraryAuthor');
            const isMine = note.author === currentUser;
            const groupClass = showAuthor ? '' : 'grouped';
            const bubbleClasses = `chat-message ${isMine ? 'message-mine' : 'message-theirs'}`;
            const avatar = `<div class="avatar" style="background-color: ${generateColor(note.author)}">${getInitials(note.author)}</div>`;
            const authorHtml = !isMine && showAuthor ? `<div class="chat-author-name">${avatar}<strong>${note.author}</strong></div>` : '';
            const timestampHtml = `<span class="item-timestamp">${new Date(note.timestamp).toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit', timeZone: 'America/Bogota'}).replace('p. m.', 'PM').replace('a. m.', 'AM')}</span>`;
            const replies = Object.values(appData.groupChat || []).filter(m => m.replyingTo === note.id);
            const replyCounter = replies.length > 0 ? `<span class="reply-counter-badge">${replies.length}</span>` : '';
            const replyButtonHtml = `<button class="reply-btn" data-type="groupChat" data-reply-to-id="${note.id}">Responder${replyCounter}</button>`;

            let replyQuoteHTML = '';
            if (note.replyingTo) {
                const originalMessage = Object.values(appData.groupChat || []).find(m => m.id === note.replyingTo);
                if (originalMessage) {
                    const quoteText = originalMessage.text.length > 60 ? originalMessage.text.substring(0, 60) + '...' : originalMessage.text;
                    replyQuoteHTML = `
                        <div class="reply-quote-block">
                            <strong class="reply-quote-author">${originalMessage.author}</strong>
                            <p class="reply-quote-text">${quoteText}</p>
                        </div>`;
                }
            }
            
            const messageContentHTML = `<div style="margin-top: 5px;">${note.text}</div>`;

            return `
                <div class="chat-message-container ${groupClass}">
                    ${authorHtml}
                    <div class="${bubbleClasses}">
                        <div class="note-content">
                            ${replyQuoteHTML}
                            ${messageContentHTML}
                            <div class="bubble-footer">
                                ${replyButtonHtml}
                                ${timestampHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        function getBirthdayHTML() {
            let confettiHTML = '';
            for(let i=0; i<9; i++) { confettiHTML += '<div class="confetti"></div>'; }
            return `<div class="birthday-banner">üéâüéÇ ¬°Feliz Cumplea√±os, Faiber! üéàü•≥${confettiHTML}</div>`;
        }
        
        function getEventDateRange() {
            const allEvents = Object.values(appData.timelineEvents || {});
            const dates = allEvents.map(e => e.date).filter(Boolean);
            if (dates.length === 0) {
                const today = new Date();
                return { start: today, end: today };
            }
            dates.sort();
            const minDate = new Date(dates[0] + 'T12:00:00');
            const maxDate = new Date(dates[dates.length - 1] + 'T12:00:00');
            return { start: minDate, end: maxDate };
        }

        function generateDayContentHTML(dateStr) {
            const allEvents = Object.values(appData.timelineEvents || {});
            const events = allEvents.filter(item => item.date === dateStr);
            let html = '';

            if(dateStr === '2026-01-15') {
                html += getBirthdayHTML();
            }
            
            const weatherStartDate = new Date('2026-01-09T00:00:00');
            const weatherEndDate = new Date('2026-01-16T23:59:59');
            const currentDate = new Date(dateStr + 'T12:00:00');
            if (currentDate >= weatherStartDate && currentDate <= weatherEndDate) {
                html += `<div class="weather-forecast" id="weather-algeciras">Cargando clima de Algeciras...</div>`;
            }
            
            const planEvents = events.filter(e => e.type !== 'note');
            const noteEvents = events.filter(e => e.type === 'note');
            if (planEvents.length > 0) {
                planEvents.forEach(item => { html += `<div class="item-description">${item.description}</div>`; if (item.flightInfo) { const buttons = item.flightInfo.flights.map(f => `<div class="flight-info"><a href="https://es.flightaware.com/live/flight/${f.num.replace(/\d/g,'')}${f.num.replace(/\D/g,'')}" target="_blank" class="flight-button">‚úàÔ∏è Ver Vuelo ${f.num}</a><span class="flight-route">${f.route}</span></div>`).join(''); html += `<div class="flight-tracker"><h4><span class="live-indicator"></span>Seguimiento en Vivo:</h4><div class="flight-buttons">${buttons}</div></div>`; } });
            } else if (noteEvents.length === 0 && dateStr !== '2026-01-15') {
                html += `<div class="item-description tbd">No hay planes para este d√≠a.</div>`;
            }
            if(noteEvents.length > 0) {
                const mostRecentNote = noteEvents.reduce((latest, current) => new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest);
                html += `<h4 class="messages-header">Notas del D√≠a</h4>`;
                html += renderMessageThreadsListHTML(noteEvents, { dataType: 'timelineEvents', collapseAfter: 3, mostRecentId: mostRecentNote.id });
            }
            return html;
        }

        function renderTimeline() {
            const timelineView = document.getElementById('timeline-view');
            const allEvents = Object.values(appData.timelineEvents || {});
            let html = '', currentMonth = -1;
            const monthFormatter = new Intl.DateTimeFormat('es-CO', { month: 'long', year: 'numeric' });
            
            const { start: startDate, end: endDate } = getEventDateRange();
            if (!startDate) return;
            endDate.setDate(endDate.getDate() + 1);
            
            const todayStr = new Date().toISOString().split('T')[0];

            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const events = allEvents.filter(item => item.date === dateStr);
                const monthName = monthFormatter.format(d).replace(/(\b[a-z](?=[a-z]{2}))/g, letter => letter.toUpperCase());
                if (d.getMonth() !== currentMonth) { 
                    currentMonth = d.getMonth(); 
                    html += `<h2>${monthName}</h2>`; 
                }
                const dayIcon = events.find(e => e.type !== 'note')?.icon || 'üóìÔ∏è';
                const todayClass = dateStr === todayStr ? 'today' : '';
                html += `<div class="timeline-item ${todayClass}" data-icon="${dayIcon}"><div class="item-content"><div class="item-date"><span>${formatAndCapitalizeDate(d)}</span><button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button></div>`;
                html += generateDayContentHTML(dateStr);
                html += `</div></div>`;
            }
            timelineView.innerHTML = html;
        }

        function renderCalendar() {
            const calendarView = document.getElementById('calendar-view'), allEvents = Object.values(appData.timelineEvents || {});
            calendarView.innerHTML = '';
            
            const { start: calStartDate, end: calEndDate } = getEventDateRange();
            if (!calStartDate) return;
            const monthsToRender = [];
            let loopDate = new Date(calStartDate.getFullYear(), calStartDate.getMonth(), 1);
            while (loopDate <= calEndDate) {
                monthsToRender.push({ y: loopDate.getFullYear(), m: loopDate.getMonth() });
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            
            const todayStr = new Date().toISOString().split('T')[0];

            monthsToRender.forEach(cal => {
                const year = cal.y, month = cal.m;
                const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                let html = `<h3>${monthNames[month]} ${year}</h3><div class="calendar-grid">`;
                const dayNames = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
                dayNames.forEach(day => { html += `<div class="calendar-header">${day}</div>`; });
                const firstDay = new Date(year, month).getDay();
                for (let i = 0; i < firstDay; i++) { html += '<div class="calendar-day other-month"></div>'; }
                const daysInMonth = 32 - new Date(year, month, 32).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = allEvents.filter(item => item.date === dateStr);
                    const noteCount = events.filter(item => item.type === 'note' && !item.replyingTo).length;
                    
                    let dayClass = 'calendar-day';
                    if (dateStr === todayStr) dayClass += ' today';

                    let dayContent = '';
                    if (dateStr === '2026-01-15') {
                        dayClass += ' birthday-date';
                        dayContent = '<span class="calendar-emoji">üéÇ</span>';
                    } else if (events.length > 0) {
                        dayContent = `<div class="event-icons-container"><span class="calendar-emoji">${events.find(e=>e.type!=="note")?.icon||"üóíÔ∏è"}</span></div>`;
                    }

                    const badge = noteCount > 0 ? `<div class="notification-badge">${noteCount}</div>` : '';
                    html += `<div class="${dayClass}" data-date="${dateStr}"><div class="day-number">${day}</div>${dayContent}${badge}</div>`;
                }
                html += '</div>'; calendarView.innerHTML += html;
            });
        }

        function renderChat() {
            const chatView = document.getElementById('chat-view');
            const allChatMessages = Object.values(appData.groupChat || []);
            allChatMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let header = `<div class="chat-header"><h2>Chat Grupal</h2><button id="fullscreen-chat-btn" class="fullscreen-btn" title="Volver a la vista principal">&#x2716;</button></div>`;
            
            let messagesHTML = renderMessageBubblesHTML(allChatMessages, { dataType: 'groupChat' });
            if (allChatMessages.length === 0) {
                messagesHTML = `<div class="item-content tbd" style="text-align:center; padding: 20px; background: transparent; border: none; backdrop-filter: none;">No hay mensajes. ¬°S√© el primero en escribir!</div>`;
            }
            const inputBarHTML = `
                <div id="chat-sent-indicator" class="chat-sent-indicator hidden">
                    Enviado 
                    <svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="6" cy="6" r="5" stroke-width="1.5"/>
                        <path d="M3.5 6 L5.5 8 L8.5 4" stroke-width="1.5"/>
                    </svg>
                </div>
                <form id="chat-form" class="chat-input-bar">
                    <select id="chat-author-select" required>
                        <option value="" disabled selected>¬øQui√©n eres?</option>
                        <option value="Anyela">Anyela</option><option value="Nathan">Nathan</option><option value="Yazmin">Yazmin</option>
                        <option value="Ron">Ron</option><option value="Yedinson">Yedinson</option><option value="Daniel">Daniel</option>
                    </select>
                    <textarea id="chat-textarea" placeholder="Escribe un mensaje..."></textarea>
                    <button type="submit" title="Enviar Mensaje">‚û§</button>
                </form>
                <p class="chat-disclaimer">Los mensajes a trav√©s de esta aplicaci√≥n no son seguros, cualquiera con este link puede acceder.</p>
            `;
            chatView.innerHTML = `<div id="chat-view-wrapper">${header}<div id="chat-messages-container">${messagesHTML}</div>${inputBarHTML}</div>`;
            const savedAuthor = localStorage.getItem('itineraryAuthor');
            if (savedAuthor) {
                document.getElementById('chat-author-select').value = savedAuthor;
            }
        }
        
        function renderInfoLists() {
            ['importantNotes', 'plannedActivities'].forEach(type => {
                const list = document.getElementById(type === 'importantNotes' ? 'important-notes-list' : 'planned-activities-list');
                const items = Object.values(appData[type] || {});
                items.sort((a,b) => (b.timestamp && a.timestamp) ? new Date(b.timestamp) - new Date(a.timestamp) : 0);
                list.innerHTML = items.map(item => `<li><div class="info-item-text">${truncateText(item.text)}</div></li>`).join("");
            });
        }
        
        function updateHeader() {
            const updateDetailsContainer = document.getElementById('update-details');
            if (!updateDetailsContainer || !appData.lastUpdate) return;
            
            const { user, time, eventDate, type } = appData.lastUpdate;
            if(!time) { updateDetailsContainer.innerHTML = ''; return; }
            
            const updateTimestamp = new Date(time).toLocaleString('es-CO', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: 'America/Bogota' });
            const lastUpdateHtml = `<div class="last-update">Actualizado por <strong>${user}</strong> ‚Ä¢ ${updateTimestamp}</div>`;
            
            let notificationHtml = '';
            const timeSinceUpdate = new Date() - new Date(time);

            if (user !== 'Sistema' && timeSinceUpdate < 600000) { // 10 minute window
                let locationText = '';
                let chipClass = '';
                if(type === 'chat') {
                    locationText = ' en Chat Grupal';
                    chipClass = 'chat-update';
                } else if (type === 'timeline' && eventDate) {
                    const dateObj = new Date(eventDate + 'T12:00:00');
                    const notificationDate = dateObj.toLocaleDateString('es-CO', { month: 'short', day: 'numeric', timeZone: 'America/Bogota' });
                    locationText = ` en: ${notificationDate}`;
                    chipClass = 'timeline-update';
                }
                notificationHtml = `<div class="notification-chip ${chipClass}">üîî Nuevo Mensaje${locationText}</div>`;
            }
            updateDetailsContainer.innerHTML = notificationHtml + lastUpdateHtml;
        }

        function getBaseHTML() { 
            return `<h1>ü§† De Austin a Medell√≠n üá®üá¥</h1>
                        <div class="status-bar" id="status-bar">
                            <div class="live-status"><span class="live-indicator"></span>En vivo</div>
                            <div class="update-details" id="update-details"></div>
                        </div>
                        <div class="how-to-banner" id="how-to-banner"><h4>¬øC√≥mo usar?</h4><p>Este es un itinerario en vivo. Aqu√≠ podr√°s seguir el conteo regresivo, ver el clima, a√±adir mensajes con <span class="icon-inline add-button-demo">+</span>, y ahora, ¬°preg√∫ntale al asistente de IA sobre el viaje con el bot√≥n ‚ú®!</p><button class="dismiss-banner-btn">No volver a mostrar</button></div>
                        <div class="countdown-container"><div class="countdown-card" id="card-nathan">Cargando...</div><div class="countdown-card" id="card-ron-anyela">Cargando...</div></div>
                        <div class="weather-widget">
                            <h3>Clima Actual</h3>
                            <div class="weather-locations">
                                <div id="weather-austin" class="weather-location-item">Cargando...</div>
                                <div class="weather-divider"></div>
                                <div id="weather-medellin" class="weather-location-item">Cargando...</div>
                            </div>
                        </div>
                        <div class="view-switcher"><button id="show-timeline" class="active">L√≠nea de Tiempo</button><button id="show-chat">Chat Grupal</button><button id="show-calendar">Calendario</button></div>
                        <div class="timeline" id="timeline-view"></div>
                        <div id="chat-view" class="view-hidden"></div>
                        <div id="calendar-view" class="view-hidden"></div>
                        <div class="info-cards-container"><h2>Informaci√≥n Adicional</h2><div class="info-card"><h3>üìù Notas Importantes <button class="add-button" data-type="importantNotes">+</button></h3><ul id="important-notes-list"></ul></div><div class="info-card"><h3>üé≤ Actividades Planeadas <button class="add-button" data-type="plannedActivities">+</button></h3><ul id="planned-activities-list"></ul></div></div>`; 
        }
        
        function showSuccessIndicator(message = '¬°Guardado!', isError = false) {
            const indicator = document.getElementById('success-indicator');
            const checkmark = indicator.querySelector('.checkmark');
            if (indicator) {
                indicator.querySelector('span').innerText = message;
                checkmark.style.display = isError ? 'none' : 'block';
                indicator.style.color = isError ? 'var(--brand-red)' : 'var(--brand-green)';
                indicator.style.background = isError ? 'rgba(255, 220, 220, 0.6)' : 'rgba(220, 255, 220, 0.6)';
                indicator.classList.remove('hidden');
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 4000);
            }
        }
        
        function showChatSentIndicator() {
            const indicator = document.getElementById('chat-sent-indicator');
             if (indicator) {
                indicator.classList.remove('hidden');
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 2000);
            }
        }
        
        function attachDynamicListeners() {
            const views = { timeline: document.getElementById('timeline-view'), calendar: document.getElementById('calendar-view'), chat: document.getElementById('chat-view') };
            document.getElementById('show-timeline').addEventListener('click', () => switchView('timeline'));
            document.getElementById('show-calendar').addEventListener('click', () => switchView('calendar'));
            document.getElementById('show-chat').addEventListener('click', () => switchView('chat'));
            
            window.switchView = function(activeView, isInitialLoad = false) {
                currentView = activeView;

                if (activeView === 'chat' && !isInitialLoad) {
                    document.body.classList.add('fullscreen-chat-active');
                } else {
                    document.body.classList.remove('fullscreen-chat-active');
                }

                Object.keys(views).forEach(key => {
                    const button = document.getElementById(`show-${key}`);
                    if (button) {
                        if (key === activeView) {
                            button.classList.add('active');
                            if(views[key]) views[key].classList.remove('view-hidden');
                        } else {
                            button.classList.remove('active');
                            if(views[key]) views[key].classList.add('view-hidden');
                        }
                    }
                });
                
                if (activeView === 'chat') {
                    setTimeout(() => {
                        const chatContainer = document.getElementById('chat-messages-container');
                        if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 0);
                }
            }
        }
        
        function openModal(options) {
            const modal = document.getElementById('add-item-modal');
            const contextContainer = document.getElementById('reply-context-container');
            contextContainer.innerHTML = '';
            contextContainer.classList.remove('is-scrollable');
            contextContainer.style.display = 'none';

            if (options.originalMessage) {
                contextContainer.style.display = 'block';
                let contextHTML = `<h4>Respondiendo a:</h4>
                <div class="reply-context original-message">
                    <strong>${options.originalMessage.author}</strong> <small>${new Date(options.originalMessage.timestamp).toLocaleString('es-CO', {timeZone: 'America/Bogota'})}</small>
                    <p>${options.originalMessage.text}</p>
                </div>`;
                
                if (options.replies && options.replies.length > 0) {
                    const repliesOldestFirst = [...options.replies].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                    const replyNumberMap = new Map(repliesOldestFirst.map((reply, index) => [reply.id, index + 1]));
                    const repliesNewestFirst = [...options.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    let repliesHtml = '<h5>Respuestas Anteriores:</h5>';
                    
                    repliesNewestFirst.forEach((reply, index) => {
                        const replyNumber = replyNumberMap.get(reply.id);
                        const numberHtml = `<span class="message-number reply">${replyNumber}</span>`;
                        const nuevoIndicator = (index === 0) ? `<strong class="recent-indicator green">M√ÅS RECIENTE</strong>` : '';
                        const timestampHtml = `<small>${nuevoIndicator} ${new Date(reply.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit', timeZone: 'America/Bogota'}).replace('.', '')}</small>`;

                        repliesHtml += `
                            <div class="reply-context">
                                <div class="author-name">${numberHtml} <strong>${reply.author}</strong></div>
                                <p>${reply.text}</p>
                                <div class="reply-context-footer">${timestampHtml}</div>
                            </div>`;
                    });
                    contextHTML += repliesHtml;
                }
                contextContainer.innerHTML = contextHTML;
                
                setTimeout(() => {
                    if (contextContainer.scrollHeight > contextContainer.clientHeight) {
                        contextContainer.classList.add('is-scrollable');
                    }
                }, 0);
            }

            modal.querySelector('#add-item-title').innerText = options.title;
            modal.querySelector('form').reset();
            modal.querySelector('#item-type-input').value = options.type;
            modal.querySelector('#item-date-input').value = options.date || '';
            modal.querySelector('#reply-to-id-input').value = options.replyToId || '';
            const savedAuthor = localStorage.getItem('itineraryAuthor');
            if (savedAuthor) {
                modal.querySelector('#author-select').value = savedAuthor;
            }
            document.getElementById('calendar-modal').classList.remove('popup-visible');
            modal.classList.add('popup-visible');
        }
        
        function sendChatMessage(author, messageData) {
            if (!author) {
                alert("Por favor, selecciona tu nombre antes de enviar un mensaje.");
                return;
            }
            localStorage.setItem('itineraryAuthor', author);
            
            const newId = `msg-${Date.now()}`;
            if (!appData.groupChat) appData.groupChat = {};
            
            const item = {
                id: newId,
                author,
                timestamp: new Date().toISOString(),
                ...messageData 
            };
            
            appData.groupChat[newId] = item;
            saveData(author, null, 'chat');
            showChatSentIndicator();
        }

        function generateItineraryContext() {
            let context = "ITINERARY CONTEXT:\n\n";
            const tempDiv = document.createElement('div');
            
            const stripHtml = (html) => {
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || "";
            };

            context += "## Timeline Events:\n";
            const events = Object.values(appData.timelineEvents || {});
            events.sort((a,b) => a.date.localeCompare(b.date));
            events.forEach(event => {
                context += `- ${event.date} (${event.icon}): ${stripHtml(event.description)}\n`;
            });

            context += "\n## Important Notes:\n";
            Object.values(appData.importantNotes || {}).forEach(note => {
                context += `- ${stripHtml(note.text)}\n`;
            });

            context += "\n## Planned Activities:\n";
            Object.values(appData.plannedActivities || {}).forEach(activity => {
                context += `- ${stripHtml(activity.text)}\n`;
            });
            
            return context;
        }

        async function askGemini(userPrompt) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("PASTE")) {
                return "Error: La clave API de Gemini no est√° configurada. Por favor, p√≠dale al administrador que la agregue.";
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            
            const itineraryContext = generateItineraryContext();
            const fullPrompt = `Based on the following travel itinerary, answer the user's question. Be helpful and concise. Today's date is ${new Date().toLocaleDateString()}. IMPORTANT: You MUST respond in SPANISH.\n\n---\n\n${itineraryContext}\n\n---\n\nUSER QUESTION: "${userPrompt}"`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    return `Error de API: ${errorData.error.message}`;
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Fetch error for Gemini API:", error);
                return "No se pudo contactar a Gemini. Revise la conexi√≥n o la clave API.";
            }
        }

        function renderGeminiConversation() {
            const container = document.getElementById('gemini-messages');
            if(!container) return;
            
            let html = geminiConversationHistory.map(msg => {
                const avatar = `<div class="avatar" style="background-color: ${generateColor(msg.role === 'user' ? 'User' : 'Gemini')}">${getInitials(msg.role === 'user' ? 'You' : 'Gemini')}</div>`;
                return `
                    <div class="gemini-message ${msg.role}">
                        ${avatar}
                        <div class="note-content"><p>${msg.text.replace(/\n/g, '<br>')}</p></div>
                    </div>
                `;
            }).join('');

            // Add suggestions if it's the start of the conversation
            if (geminiConversationHistory.length === 1 && geminiConversationHistory[0].role === 'model') {
                 const suggestions = [
                    "¬øCu√°ndo llega Nathan?", 
                    "¬øQu√© actividades tenemos planeadas?", 
                    "Hazme un resumen del 15 de enero",
                    "¬øQui√©n no sabe del secreto?"
                ];
                html += '<div class="gemini-suggestions">';
                suggestions.forEach(s => {
                    html += `<button class="gemini-suggestion">${s}</button>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        attachStaticListeners(); 
        
        function attachStaticListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('#enter-button')) { const overlay = document.getElementById('pre-screen-overlay'); if (overlay) { overlay.classList.add('hidden'); setTimeout(() => { overlay.style.display = 'none'; }, 700); } return; }
                if (target.matches('.dismiss-banner-btn')) { const banner = target.closest('.how-to-banner'); if(banner) banner.style.display = 'none'; localStorage.setItem('itineraryBannerDismissed', 'true'); return; }
                if (target.matches('.toggle-text-btn')) { 
                    e.preventDefault();
                    const parent = target.parentElement;
                    const ellipsis = parent.querySelector('.ellipsis');
                    const moreText = parent.querySelector('.more-text');
                    const isHidden = moreText.style.display === 'none';
                    
                    ellipsis.style.display = isHidden ? 'none' : 'inline';
                    moreText.style.display = isHidden ? 'inline' : 'none';
                    target.textContent = isHidden ? 'Ver menos' : 'Ver m√°s';
                    return;
                }
                
                if (target.matches('.toggle-visibility-link')) {
                    const hiddenContent = target.previousElementSibling;
                    const isHidden = hiddenContent.style.display === 'none' || hiddenContent.style.display === '';
                    if (isHidden) {
                        hiddenContent.style.display = 'block';
                        target.textContent = 'Ocultar mensajes anteriores';
                    } else {
                        hiddenContent.style.display = 'none';
                        const count = target.dataset.count;
                        target.textContent = `Ver ${count} mensajes anteriores`;
                    }
                    return;
                }
                
                const popup = target.closest('.popup-overlay');
                if (popup && (target === popup || target.matches('.close-popup') || target.matches('.modal-close-button'))) { 
                    popup.classList.remove('popup-visible'); 
                    return; 
                }
                
                const fullscreenBtn = target.closest('#fullscreen-chat-btn');
                if(fullscreenBtn) {
                    document.body.classList.remove('fullscreen-chat-active');
                    switchView('timeline');
                    return;
                }

                const calendarDay = target.closest('.calendar-day:not(.other-month)');
                if(calendarDay) {
                    const dateStr = calendarDay.dataset.date;
                    const date = new Date(dateStr + 'T12:00:00');
                    document.getElementById('modal-date').innerHTML = `<span>${formatAndCapitalizeDate(date)}</span><button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button>`;
                    document.getElementById('modal-events').innerHTML = `<div class="item-content">${generateDayContentHTML(dateStr)}</div>`;
                    document.getElementById('calendar-modal').classList.add('popup-visible');
                    fetchWeather();
                    const allEvents = Object.values(appData.timelineEvents || {});
                    const eventsOnDay = allEvents.filter(item => item.date === dateStr);
                    if (eventsOnDay.length === 0 && dateStr !== '2026-01-15') { 
                        setTimeout(() => { 
                            const addButton = document.querySelector('#modal-date .add-button'); 
                            if(addButton) addButton.click(); 
                        }, 50); 
                    }
                    return;
                }
                const replyButton = target.closest('.reply-btn');
                if(replyButton) {
                    const type = replyButton.dataset.type;
                    const replyToId = replyButton.dataset.replyToId;
                    const date = replyButton.dataset.date || '';
                    const messagePool = (type === 'groupChat') ? Object.values(appData.groupChat || {}) : Object.values(appData.timelineEvents || {});
                    const originalMessage = messagePool.find(m => m.id === replyToId);

                    if (originalMessage) {
                        let replies = [];
                        if(type === 'groupChat' || type === 'timelineEvents') {
                            replies = messagePool.filter(m => m.replyingTo === replyToId)
                                               .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                        }
                        openModal({ 
                            title: `Responder a ${originalMessage.author}`, 
                            type: type, 
                            date: date, 
                            replyToId: replyToId,
                            originalMessage: originalMessage,
                            replies: replies
                        });
                    }
                    return;
                }
                const addButton = target.closest('.add-button');
                if(addButton) {
                    const type = addButton.dataset.type;
                    const itemDate = addButton.dataset.date || '';
                    let title = type === 'importantNotes' ? 'A√±adir Nota Importante' : 
                                type === 'plannedActivities' ? 'A√±adir Actividad' : 'A√±adir Nota';
                    openModal({ title: title, type: type, date: itemDate });
                    return;
                }
                
                const geminiFab = target.closest('#gemini-fab');
                const geminiOverlay = document.getElementById('gemini-overlay');
                if (geminiFab) {
                    geminiOverlay.classList.add('visible');
                    const geminiContainer = geminiOverlay.querySelector('.gemini-container');
                    geminiContainer.classList.add('glowing-effect');
                    geminiContainer.addEventListener('animationend', () => {
                        geminiContainer.classList.remove('glowing-effect');
                    }, { once: true });

                    if(geminiConversationHistory.length === 0) {
                        geminiConversationHistory.push({role: 'model', text: "¬°Hola! He le√≠do el itinerario del viaje. ¬øEn qu√© puedo ayudarte a planificar?"});
                        renderGeminiConversation();
                    }
                }
                const closeGeminiBtn = target.closest('#gemini-overlay .close-popup');
                if (closeGeminiBtn || target.id === 'gemini-overlay') {
                    geminiOverlay.classList.remove('visible');
                }

                const suggestionBtn = target.closest('.gemini-suggestion');
                if(suggestionBtn) {
                    const prompt = suggestionBtn.textContent;
                    const input = document.getElementById('gemini-input');
                    input.value = prompt;
                    document.querySelector('#gemini-form button').click();
                }
            });

            document.body.addEventListener('submit', function(e) {
                if(e.target.id === 'chat-form') {
                    e.preventDefault();
                    const authorSelect = document.getElementById('chat-author-select');
                    const textarea = document.getElementById('chat-textarea');
                    const author = authorSelect.value;
                    const text = textarea.value.trim();
                    
                    if (text) {
                        sendChatMessage(author, { text: text });
                        textarea.value = '';
                        textarea.style.height = 'auto';
                    }
                } else if (e.target.id === 'add-item-form') {
                    e.preventDefault(); 
                    const type = document.getElementById('item-type-input').value;
                    const text = document.getElementById('item-description-input').value.trim();
                    const author = document.getElementById('author-select').value;
                    if (!type || !text || !author) { alert("Por favor, completa todos los campos."); return; }
                    localStorage.setItem('itineraryAuthor', author);
                    
                    const newId = `${type.slice(0,4)}-${Date.now()}`;
                    if (!appData[type]) appData[type] = {};
                    
                    const item = { id: newId, text, author, timestamp: new Date().toISOString() };
                    const replyingToId = document.getElementById('reply-to-id-input').value;
                    if(replyingToId) item.replyingTo = replyingToId;
                    
                    let notificationType = 'general';
                    let eventDateForNotification = null;

                    if (type === 'timelineEvents') { 
                        item.date = document.getElementById('item-date-input').value; 
                        item.icon = 'üóíÔ∏è'; 
                        item.type = 'note'; 
                        eventDateForNotification = item.date;
                        notificationType = 'timeline';
                    }
                    
                    appData[type][newId] = item;
                    saveData(author, eventDateForNotification, notificationType);
                    
                    document.getElementById('add-item-modal').classList.remove('popup-visible');
                    showSuccessIndicator();
                } else if (e.target.id === 'gemini-form') {
                    e.preventDefault();
                    const input = document.getElementById('gemini-input');
                    const prompt = input.value.trim();
                    if (!prompt) return;

                    geminiConversationHistory.push({ role: 'user', text: prompt });
                    geminiConversationHistory.push({ role: 'model', text: 'Pensando...' });
                    renderGeminiConversation();
                    input.value = '';

                    askGemini(prompt).then(response => {
                        geminiConversationHistory.pop();
                        geminiConversationHistory.push({ role: 'model', text: response });
                        renderGeminiConversation();
                    });
                }
            });
        }

        // --- INITIALIZATION ---
        setInterval(updateCountdowns, 1000);
        setInterval(fetchWeather, 300000);
    });
    </script>
</body>
</html>
