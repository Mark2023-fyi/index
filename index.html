<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario: Austin a Medell√≠n</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap');
        body{font-family:'Poppins',sans-serif;background-color:#f0f2f5;color:#333;margin:0;padding:20px}.container{max-width:800px;margin:0 auto}h1,h2,h3{text-align:center;color:#1c2a39}h1{font-size:2.2em;margin-bottom:15px}h2{font-size:1.5em;margin:40px 0 20px;color:#007bff}
        .status-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;background-color:#fff;padding:8px 15px;border-radius:10px;font-size:0.85em;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,.05);gap:15px}
        .live-status{display:flex;align-items:center;gap:8px;font-weight:600;color:#d9534f;}
        .update-details{display:flex;align-items:center;gap:10px;flex-grow:1;justify-content:flex-end;}
        .last-update{color:#6c757d;text-align:right;}
        .notification-chip{background-color:#28a745;color:white;padding:5px 12px;border-radius:16px;font-weight:600;display:flex;align-items:center;gap:5px;white-space:nowrap;}
        .how-to-banner{background-color:#e3f2fd;border:1px solid #90caf9;border-radius:10px;padding:15px 20px;margin-bottom:30px;position:relative;display:none;}
        .how-to-banner h4{margin:0 0 10px 0;color:#0d47a1;text-align:left;}
        .how-to-banner p{margin:0 0 10px 0;font-size:0.9em;line-height:1.6;text-align:left;}
        .dismiss-banner-btn{background:none;border:none;color:#555;text-decoration:underline;font-size:0.8em;cursor:pointer;padding:5px;margin-top:5px;display:block;}
        .dismiss-banner-btn:hover{color:#0d47a1;}
        .icon-inline{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle;margin:0 2px;}
        .add-button-demo{background-color:#007bff;color:white;border-radius:50%;width:18px;height:18px;font-size:14px;font-weight:bold;line-height:18px;text-align:center;}
        .notification-badge-demo{background-color:#ff4d4d;color:white;border-radius:50%;min-width:18px;height:18px;padding:0 3px;font-size:12px;line-height:18px;text-align:center;font-weight:bold;}
        .countdown-container,.weather-container{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;gap:15px;margin-bottom:15px}.countdown-card{background:#1d2b38;color:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.15);flex:1;min-width:280px;min-height:105px;display:flex;flex-direction:column;justify-content:center}.countdown-card h3{margin-top:0;margin-bottom:10px;font-size:1.1em;font-weight:400;color:#00aaff}.countdown-card .arrival-date{margin:-5px 0 15px 0;font-size:0.85em;color:#9ab;opacity:0.9}.timer{display:flex;justify-content:center;gap:15px;font-family:'Roboto Mono',monospace}.time-block{display:flex;flex-direction:column;min-width:55px}.time-block span:first-child{font-size:2.2em;font-weight:700;color:#f0f2f5;line-height:1}.time-block span:last-child{font-size:.7em;text-transform:uppercase;color:#9ab}.timeline{position:relative;padding:20px 0}.timeline::before{content:'';position:absolute;top:0;left:21px;height:100%;width:4px;background:#e0e0e0}.timeline-item{padding:10px 40px;position:relative;margin-left:25px;margin-bottom:20px}.timeline-item::before{content:attr(data-icon);position:absolute;left:-28px;top:50%;transform:translateY(-50%);width:56px;height:56px;border-radius:50%;background:#fff;border:3px solid #007bff;text-align:center;line-height:56px;font-size:2.5em}.item-content{background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08)}.item-date{font-weight:600;color:#007bff;font-size:1.1em;margin-bottom:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;}.item-date span{flex-grow:1;}.tbd{color:#7f8c8d;font-style:italic}
        .flight-tracker{border-top:1px solid #eee;margin-top:15px;padding-top:15px;display:flex;flex-direction:column;gap:10px;align-items:center}
        .flight-tracker h4{margin:0 0 5px 0;font-weight:600;color:#333;display:flex;align-items:center;gap:8px}
        .live-indicator{display:inline-block;width:10px;height:10px;background-color:#ff4d4d;border-radius:50%;animation:blinker 1.5s linear infinite}@keyframes blinker{50%{opacity:0}}.flight-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center}
        .flight-info{display:flex;flex-direction:column;align-items:center}
        .flight-button{display:inline-block;background-color:#007bff;color:#fff;padding:8px 15px;border-radius:5px;text-decoration:none;font-weight:500;font-size:0.9em;transition:background-color .2s,transform .2s}.flight-button:hover{background-color:#0056b3;transform:translateY(-2px)}
        .flight-route{font-size:0.8em;color:#555;margin-top:4px}
        .info-card{background-color:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px}.info-card h3{margin-top:0;color:#007bff; display: flex; justify-content: space-between; align-items: center;}.info-card ul{padding-left:0;margin:0; list-style-type: none;}.info-card li{display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #f0f0f0;}.info-card li:last-child{border-bottom:none;}.info-item-text{flex-grow:1;}
        .weather-card{background:#fff;border:1px solid #ddd;padding:10px 15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);flex:1;min-width:260px;display:flex;flex-direction:row;justify-content:space-between;align-items:center}.weather-card-left{text-align:left}.weather-card .city{font-weight:600;font-size:1em;margin:0}.weather-card .time{font-family:'Roboto Mono',monospace;font-size:1.1em;margin:2px 0 0 0;color:#555}.weather-card-right{display:flex;align-items:center;gap:8px}.weather-card .icon{font-size:2em;line-height:1}.weather-card .temp{font-size:1.2em;font-weight:600}
        .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}.popup-visible{opacity:1!important;visibility:visible!important}.popup-content{background:#fff;padding:20px 30px 30px;border-radius:10px;box-shadow:0 5px 25px rgba(0,0,0,.3);position:relative;max-width:450px;width:100%;text-align:center;transform:scale(.9);transition:transform .3s}.popup-visible .popup-content{transform:scale(1)}.popup-content h2{margin-top:0;margin-bottom:15px;}.close-popup{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer;transition:color .2s}.close-popup:hover{color:#333}
        #modal-date{display:flex;justify-content:space-between;align-items:center;width:100%;gap:15px;margin-right:20px;}
        .view-switcher{display:flex;justify-content:center;margin-bottom:30px;background:#e0e0e0;border-radius:10px;padding:5px}
        .view-switcher button{border:none;padding:10px 20px;font-family:'Poppins',sans-serif;font-size:1em;font-weight:600;background:transparent;color:#555;border-radius:8px;cursor:pointer;transition:all .3s ease}
        .view-switcher button.active{background:#fff;color:#007bff;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .view-hidden{display:none}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#ccc;border:1px solid #ccc;border-radius:8px;overflow:hidden}
        .calendar-header{font-weight:600;text-align:center;padding:8px 0;font-size:0.9em;background:#f8f9fa}
        .calendar-day{background:#fff;min-height:80px;padding:4px;font-size:0.8em;display:flex;flex-direction:column;position:relative}
        .calendar-day:not(.other-month){cursor:pointer;transition:background .2s}.calendar-day:not(.other-month):hover{background:#f1f8ff}
        .calendar-day.other-month{background:#f9f9f9;color:#ccc}
        .calendar-day .day-number{font-weight:600;margin-bottom:5px;text-align:right}
        .event-icons-container{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;padding:0 2px;margin-top:4px}
        .calendar-emoji{font-size:1.6em;line-height:1}
        .item-description{padding-bottom:8px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;display:flex;align-items:flex-start;gap:8px;}.item-description:last-child{border-bottom:none;margin-bottom:0;}
        .note-content{flex-grow:1;}.author-name{font-size:0.9em;font-weight:600}
        .item-description.grouped-message{margin-top:-4px;padding-top:4px}
        .item-timestamp{display:block; font-size:0.7em; color:#888; margin-top:5px;}
        #modal-events .item-description{margin-bottom:4px;padding-bottom:4px;}
        #modal-events .item-content{box-shadow:none;padding:0;}
        .modal-close-button{border:none;background:#007bff;color:#fff;padding:10px 25px;font-size:1em;font-weight:600;border-radius:5px;margin-top:20px;cursor:pointer;transition:background .2s}.modal-close-button:hover{background:#0056b3}
        .add-button{background-color:#007bff;color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:16px;font-weight:bold;line-height:24px;cursor:pointer;transition:all .2s;flex-shrink:0;}.add-button:hover{background-color:#0056b3;transform:scale(1.1)}
        #add-item-modal textarea, #add-item-modal select{width:100%;margin-top:10px;padding:10px;border-radius:5px;border:1px solid #ccc;font-family:'Poppins',sans-serif;font-size:1em;box-sizing:border-box}
        .notification-badge{position:absolute;top:4px;left:4px;background-color:#ff4d4d;color:white;border-radius:50%;width:18px;height:18px;font-size:11px;line-height:18px;text-align:center;font-weight:bold;}
        .timeline-notification-badge{background-color:#ff4d4d;color:white;border-radius:50%;min-width:20px;height:20px;padding:0 3px;font-size:12px;line-height:20px;text-align:center;font-weight:bold;}
        .messages-header{font-weight:600;color:#333;font-size:1em;margin:15px 0 5px 0;padding-top:10px;border-top:1px solid #eee;}
        .toggle-notes-btn{background:none;border:1px solid #007bff;color:#007bff;padding:5px 10px;border-radius:5px;cursor:pointer;font-family:'Poppins',sans-serif;font-size:0.8em;font-weight:600;margin-top:10px;}.toggle-notes-btn:hover{background:#e3f2fd;}
        .weather-forecast{background-color:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:8px 12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;font-size:0.9em;}
        .weather-icon{font-size:1.5em;}
        footer{text-align:center;margin-top:40px;font-size:0.8em;color:#999;}
    </style>
</head>
<body>
    <div id="privacy-popup" class="popup-overlay"><div class="popup-content"><span class="close-popup">&times;</span><h2 style="color:#ffc107">‚ö†Ô∏è ¬°Cuidado!</h2><p>Para uso interno solamente. El link es abierto y cualquiera puede acceder y ver su informaci√≥n.</p><p style="font-size:0.8em; color:#777;">(Este mensaje desaparecer√° el 4 de enero, 2026).</p><button class="modal-close-button">OK</button></div></div>
    <div id="calendar-modal" class="popup-overlay"><div class="popup-content"><span class="close-popup">&times;</span><h2 id="modal-date"></h2><div id="modal-events"></div><button class="modal-close-button">OK</button></div></div>
    <div id="add-item-modal" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup">&times;</span>
            <h2 id="add-item-title">A√±adir Entrada</h2>
            <form id="add-item-form">
                <input type="hidden" id="item-id-input"><input type="hidden" id="item-type-input"><input type="hidden" id="item-date-input">
                <div id="author-select-container">
                    <select id="author-select" required>
                        <option value="" disabled selected>¬øQui√©n eres?</option>
                        <option value="Anyela">Anyela</option><option value="Nathan">Nathan</option><option value="Yazmin">Yazmin</option><option value="Ron">Ron</option><option value="Yedinson">Yedinson</option><option value="Daniel">Daniel</option>
                    </select>
                </div>
                <textarea id="item-description-input" placeholder="Escribe tu nota o plan aqu√≠..." required></textarea>
                <button type="submit" class="modal-close-button">Guardar</button>
            </form>
        </div>
    </div>

    <div class="container" id="main-container">
        </div>
    
    <footer>Version 082525</footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIG & DATA ---
        const firebaseConfig = { apiKey: "AIzaSyBrIoHLMIN9XmcTIsTiQQsCUYAKGJut_U8", authDomain: "itinerario-viaje-cbf9d.firebaseapp.com", databaseURL: "https://itinerario-viaje-cbf9d-default-rtdb.firebaseio.com", projectId: "itinerario-viaje-cbf9d", storageBucket: "itinerario-viaje-cbf9d.appspot.com", messagingSenderId: "88371586960", appId: "1:88371586960:web:8b2dd61a4b7d2bed963515" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const appDataRef = database.ref('appData');
        let appData = {};
        const defaultAppData = { lastUpdate: { user: "Sistema", time: new Date().toISOString() }, timelineEvents: { "event-1":{id:"event-1",date:"2025-12-13",icon:"üõ¨",description:"<strong>PM:</strong> LLegada de Nathan a Medellin desde USA.",type:"flight",flightInfo:{title:"Llegada de Nathan",flights:[{num:"CM716",route:"Austin ‚Üí Panam√°"},{num:"CM155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-2":{id:"event-2",date:"2025-12-22",icon:"üè†",description:"Regreso de Nathan a Medellin.",type:"flight",flightInfo:{title:"Regreso de Nathan",flights:[{num:"EFY821",route:"Villavicencio ‚Üí Medell√≠n"}]}},"event-3":{id:"event-3",date:"2025-12-24",icon:"üéÑ",description:"Celebraci√≥n de Nochebuena üéÖ",type:"holiday"},"event-4":{id:"event-4",date:"2025-12-25",icon:"üéÅ",description:"D√≠a de Navidad üåü",type:"holiday"},"event-5":{id:"event-5",date:"2025-12-31",icon:"üéâ",description:"Celebraci√≥n de Fin de A√±o ü•Ç",type:"holiday"},"event-6":{id:"event-6",date:"2026-01-01",icon:"ü•Ç",description:"D√≠a de A√±o Nuevo. Descanso. üéâ",type:"holiday"},"event-7":{id:"event-7",date:"2026-01-03",icon:"üõ¨",description:"<strong>PM:</strong> Llegada de Ron y Anyela a Medell√≠n desde USA.",type:"flight",flightInfo:{title:"Llegada de Ron y Anyela",flights:[{num:"CM716",route:"Austin ‚Üí Panam√°"},{num:"CM155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-8":{id:"event-8",date:"2026-01-04",icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",description:"Primer encuentro familiar. Almuerzo (hora por definir).",type:"celebration"},"event-9":{id:"event-9",date:"2026-01-12",icon:"üéä",description:"D√≠a en Algeciras (D√≠a Festivo üéä). Planes por determinar.",type:"holiday"},"event-10":{id:"event-10",date:"2026-01-15",icon:"üéÇ",description:"<strong>AM:</strong> Llegada - Bus - De la Familia a Medellin.<br><strong>PM:</strong> Salida y llegada - Vuelo - Ron, Anyela y Nathan para Medellin.",type:"travel"},"event-11":{id:"event-11",date:"2026-01-17",icon:"üõ´",description:"<strong>AM:</strong> Salida del resto del grupo desde Medell√≠n a USA. Fin del viaje.",type:"flight",flightInfo:{title:"Vuelos de Regreso",flights:[{num:"CM209",route:"Medell√≠n ‚Üí Panam√°"},{num:"CM715",route:"Panam√° ‚Üí Austin"}]}}}, importantNotes: { "note-101":{id:"note-101",text:"<strong>¬°PRIVADO!</strong> Maria Helena, Yedinson, y Yazmin ya saben."},"note-102":{id:"note-102",text:"Faber, Yisela, y Rosita no saben absolutamente nada."} }, plannedActivities: { "activity-201":{id:"activity-201",text:"Bingo"},"activity-202":{id:"activity-202",text:'Regalos con la letra "V" de un valor de $10,000 pesos'},"activity-203":{id:"activity-203",text:"Scavenger Hunt (B√∫squeda del tesoro)"},"activity-204":{id:"activity-204",text:"Pictionary"} } };
        
        // --- WIDGETS ---
        function updateCountdowns() {
            const targets = [ { id: 'card-nathan', date: '2025-12-13T18:00:00', title: 'Llegada de Nathan' }, { id: 'card-ron-anyela', date: '2026-01-03T18:00:00', title: 'Llegada de Ron & Anyela' }];
            targets.forEach(target => { const el=document.getElementById(target.id); if(!el) return; const t=new Date(target.date).getTime(), n=new Date().getTime(), d=t-n; let c=`<h3>${target.title}</h3><div class="arrival-date">${new Date(target.date).toLocaleDateString("es-CO",{month:"long",day:"numeric"})}</div>`; if(d<0) c+="<h4>¬°Ya lleg√≥!</h4>"; else {const s=Math.floor(d/864e5),o=Math.floor(d%864e5/36e5),i=Math.floor(d%36e5/6e4),a=Math.floor(d%6e4/1e3);c+=`<div class="timer"><div class="time-block"><span>${String(s).padStart(2,"0")}</span><span>D√≠as</span></div><div class="time-block"><span>${String(o).padStart(2,"0")}</span><span>Horas</span></div><div class="time-block"><span>${String(i).padStart(2,"0")}</span><span>Min</span></div><div class="time-block"><span>${String(a).padStart(2,"0")}</span><span>Seg</span></div></div>`} el.innerHTML=c });
        }
        async function fetchWeather() {
            const locations = [{id:'weather-austin',city:'Austin',emoji:'ü§†'},{id:'weather-medellin',city:'Medellin',emoji:'üá®üá¥'}];
            for (const loc of locations) { const el=document.getElementById(loc.id); if(!el) continue; try { const res=await fetch(`https://wttr.in/${loc.city}?format=j1`), data=await res.json(), tempC=data.current_condition[0].temp_C, tempF=data.current_condition[0].temp_F; el.innerHTML=`<div class="weather-card-left"><div class="city">${loc.emoji} ${loc.city}</div><div class="time">${new Date().toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"})}</div></div><div class="weather-card-right"><div class="icon">üå°Ô∏è</div><div class="temp">${tempF}¬∞F / ${tempC}¬∞C</div></div>` } catch (error) { el.innerText = `Error clima ${loc.city}.` } }
        }

        // --- DATA & RENDER LOGIC ---
        function saveData(user, itemDate = null) {
            if(user) appData.lastUpdate = { user:user, time:new Date().toISOString(), eventDate:itemDate };
            appDataRef.set(appData); 
        }
        appDataRef.on('value', (snapshot) => {
            const data = snapshot.val();
            appData = (data && data.timelineEvents) ? data : JSON.parse(JSON.stringify(defaultAppData));
            renderApp();
        });
        const dayFormatter = new Intl.DateTimeFormat('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
        
        function handleBannerVisibility() {
            const banner = document.getElementById('how-to-banner');
            if (banner && localStorage.getItem('itineraryBannerDismissed') !== 'true') {
                banner.style.display = 'block';
            }
        }

        function getAlgecirasWeatherHTML() {
            return `<div class="weather-forecast"><span class="weather-icon">üå•Ô∏è</span> <span class="weather-temp">29¬∞/19¬∞C</span> &nbsp;‚Ä¢&nbsp; Algeciras</div>`;
        }

        function renderApp() {
            document.getElementById('main-container').innerHTML = getBaseHTML();
            renderTimeline(); 
            renderCalendar(); 
            renderInfoLists();
            attachDynamicListeners();
            updateHeader();
            updateCountdowns();
            fetchWeather();
            handleBannerVisibility();
        }

        function generateDayContentHTML(events, dateStr) {
            let html = '';
            const planEvents = events.filter(e => e.type !== 'note');
            const noteEvents = events.filter(e => e.type === 'note');

            if (planEvents.length > 0) {
                planEvents.forEach(item => {
                    html += `<div class="item-description">${item.description}</div>`;
                    if (item.flightInfo) {
                        const buttons = item.flightInfo.flights.map(f => `<div class="flight-info"><a href="https://es.flightaware.com/live/flight/${f.num.replace(/\d/g,'')}${f.num.replace(/\D/g,'')}" target="_blank" class="flight-button">‚úàÔ∏è Ver Vuelo ${f.num}</a><span class="flight-route">${f.route}</span></div>`).join('');
                        html += `<div class="flight-tracker"><h4><span class="live-indicator"></span>Seguimiento en Vivo:</h4><div class="flight-buttons">${buttons}</div></div>`;
                    }
                });
            } else if (noteEvents.length === 0) {
                 html = `<div class="item-description tbd">No hay planes para este d√≠a.</div>`;
            }
            
            if (noteEvents.length > 0) {
                noteEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                html += '<h4 class="messages-header">Mensajes:</h4>';
                
                let lastAuthor = null;
                const renderNote = note => {
                    const showAuthor = note.author !== lastAuthor;
                    lastAuthor = note.author;
                    const authorHtml = showAuthor ? `<strong class="author-name">${note.author}:</strong> ` : '';
                    const groupClass = showAuthor ? '' : 'grouped-message';
                    return `<div class="item-description ${groupClass}"><div class="note-content">${authorHtml}${note.text}<span class="item-timestamp">${new Date(note.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</span></div></div>`;
                };
                
                html += noteEvents.slice(0, 3).map(renderNote).join('');
                if (noteEvents.length > 3) {
                    html += `<div id="notes-${dateStr}" class="collapsible-notes" style="display:none;">${noteEvents.slice(3).map(renderNote).join('')}</div>`;
                    html += `<button class="toggle-notes-btn" data-target="notes-${dateStr}">Ver ${noteEvents.length - 3} mensajes m√°s</button>`;
                }
            }
            return html;
        }

        function renderTimeline() {
            const timelineView = document.getElementById('timeline-view');
            const allEvents = Object.values(appData.timelineEvents || {});
            let html = '', currentMonth = -1;
            const monthFormatter = new Intl.DateTimeFormat('es-CO', { month: 'long' });
            const startDate = new Date('2025-12-13T12:00:00'), endDate = new Date('2026-01-17T12:00:00');
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const events = allEvents.filter(item => item.date === dateStr);
                const noteCount = events.filter(item => item.type === 'note').length;
                const badge = noteCount > 0 ? `<div class="timeline-notification-badge">${noteCount}</div>` : '';
                if (d.getMonth() !== currentMonth) { currentMonth = d.getMonth(); html += `<h2>${monthFormatter.format(d)} ${d.getFullYear()}</h2>`; }
                const dayIcon = events.length > 0 ? events.find(e => e.type !== 'note')?.icon || 'üóíÔ∏è' : 'üóìÔ∏è';
                html += `<div class="timeline-item" data-icon="${dayIcon}"><div class="item-content"><div class="item-date"><span>${dayFormatter.format(d)}</span>${badge}<button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button></div>`;
                
                const weatherStartDate = new Date('2026-01-09T00:00:00'), weatherEndDate = new Date('2026-01-16T23:59:59');
                if (d >= weatherStartDate && d <= weatherEndDate) {
                    html += getAlgecirasWeatherHTML();
                }

                html += generateDayContentHTML(events, dateStr);
                html += `</div></div>`;
            }
            timelineView.innerHTML = html;
        }

        function renderCalendar() {
            const calendarView = document.getElementById('calendar-view'), allEvents = Object.values(appData.timelineEvents || {});
            calendarView.innerHTML = '';
            [ {y:2025, m:11}, {y:2026, m:0} ].forEach(cal => {
                const year = cal.y, month = cal.m, monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                let html = `<h3>${monthNames[month]} ${year}</h3><div class="calendar-grid">`;
                const dayNames = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
                dayNames.forEach(day => { html += `<div class="calendar-header">${day}</div>`; });
                const firstDay = new Date(year, month).getDay();
                for (let i = 0; i < firstDay; i++) { html += '<div class="calendar-day other-month"></div>'; }
                const daysInMonth = 32 - new Date(year, month, 32).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = allEvents.filter(item => item.date === dateStr);
                    const noteCount = events.filter(item => item.type === 'note').length;
                    const eventHTML = events.length > 0 ? `<div class="event-icons-container"><span class="calendar-emoji">${events.find(e=>e.type!=="note")?.icon||"üóíÔ∏è"}</span></div>` : '';
                    const badge = noteCount > 0 ? `<div class="notification-badge">${noteCount}</div>` : '';
                    html += `<div class="calendar-day" data-date="${dateStr}"><div class="day-number">${day}</div>${eventHTML}${badge}</div>`;
                }
                html += '</div>'; calendarView.innerHTML += html;
            });
        }

        function renderInfoLists() {
            ['importantNotes', 'plannedActivities'].forEach(type => {
                const list = document.getElementById(type === 'importantNotes' ? 'important-notes-list' : 'planned-activities-list');
                const items = Object.values(appData[type] || {});
                items.sort((a,b) => (b.timestamp && a.timestamp) ? new Date(b.timestamp) - new Date(a.timestamp) : 0);
                list.innerHTML = items.map(item => {
                    const timestamp = item.timestamp ? `<span class="item-timestamp">${new Date(item.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</span>` : '';
                    return `<li><div class="info-item-text">${item.text}${timestamp}</div></li>`
                }).join('');
            });
        }
        
        function updateHeader() {
            const updateDetailsContainer = document.getElementById('update-details');
            if (!updateDetailsContainer) return;
            const { user, time, eventDate } = appData.lastUpdate || {};
            if(!time) { updateDetailsContainer.innerHTML = ''; return; }

            const updateTimestamp = new Date(time).toLocaleString('es-CO', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            const formattedTimestamp = updateTimestamp.charAt(0).toUpperCase() + updateTimestamp.slice(1).replace('.','');
            const lastUpdateHtml = `<div class="last-update">Actualizado por <strong>${user}</strong> ‚Ä¢ ${formattedTimestamp}</div>`;

            let notificationHtml = '';
            if (user !== 'Sistema' && (new Date() - new Date(time)) < 600000) { // 10 min window
                let dateText = '';
                if (eventDate) {
                    const dateObj = new Date(eventDate + 'T12:00:00');
                    const notificationDate = dateObj.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
                    dateText = ` en: ${notificationDate.charAt(0).toUpperCase() + notificationDate.slice(1).replace('.','')}`;
                }
                notificationHtml = `<div class="notification-chip">üîî Nuevo Mensaje${dateText}</div>`;
            }
            updateDetailsContainer.innerHTML = notificationHtml + lastUpdateHtml;
        }

        function getBaseHTML() { 
            return `<h1>ü§† De Austin a Medell√≠n üá®üá¥</h1>
                <div class="status-bar" id="status-bar">
                    <div class="live-status"><span class="live-indicator"></span>En vivo</div>
                    <div class="update-details" id="update-details"></div>
                </div>
                <div class="how-to-banner" id="how-to-banner">
                    <h4>¬øC√≥mo usar?</h4>
                    <p>Este es un itinerario en vivo. Aqu√≠ podr√°s seguir el conteo regresivo, ver el clima, a√±adir mensajes al presionar el bot√≥n <span class="icon-inline add-button-demo">+</span>, mirar notificaciones de mensajes nuevos cuando veas este √≠cono <span class="icon-inline notification-badge-demo">6</span> y seguir los vuelos en vivo <span class="icon-inline"><span class="live-indicator"></span></span>.</p>
                    <button class="dismiss-banner-btn">No volver a mostrar</button>
                </div>
                <div class="countdown-container"><div class="countdown-card" id="card-nathan">Cargando...</div><div class="countdown-card" id="card-ron-anyela">Cargando...</div></div>
                <div class="weather-container"><div id="weather-austin" class="weather-card">Cargando Clima...</div><div id="weather-medellin" class="weather-card">Cargando Clima...</div></div>
                <div class="view-switcher"><button id="show-timeline" class="active">L√≠nea de Tiempo</button><button id="show-calendar">Calendario</button></div>
                <div class="timeline" id="timeline-view"></div>
                <div id="calendar-view" class="view-hidden"></div>
                <div class="info-cards-container"><h2>Informaci√≥n Adicional</h2><div class="info-card"><h3>üìù Notas Importantes <button class="add-button" data-type="importantNotes">+</button></h3><ul id="important-notes-list"></ul></div><div class="info-card"><h3>üé≤ Actividades Planeadas <button class="add-button" data-type="plannedActivities">+</button></h3><ul id="planned-activities-list"></ul></div></div>`;
        }
        
        function attachDynamicListeners() {
            const timelineView = document.getElementById('timeline-view'), calendarView = document.getElementById('calendar-view');
            document.getElementById('show-timeline').addEventListener('click', () => { document.getElementById('show-timeline').classList.add('active'); document.getElementById('show-calendar').classList.remove('active'); timelineView.classList.remove('view-hidden'); calendarView.classList.add('view-hidden'); });
            document.getElementById('show-calendar').addEventListener('click', () => { document.getElementById('show-calendar').classList.add('active'); document.getElementById('show-timeline').classList.remove('active'); calendarView.classList.remove('view-hidden'); timelineView.classList.add('view-hidden'); });
        }
        
        function attachStaticListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.matches('.dismiss-banner-btn')) {
                    const banner = target.closest('.how-to-banner');
                    if(banner) banner.style.display = 'none';
                    localStorage.setItem('itineraryBannerDismissed', 'true');
                    return;
                }

                const popup = target.closest('.popup-overlay');
                if (popup && (target === popup || target.matches('.close-popup, .modal-close-button'))) { popup.classList.remove('popup-visible'); return; }

                if (target.matches('.toggle-notes-btn')) {
                    const targetId = target.dataset.target, notesDiv = document.getElementById(targetId);
                    if (notesDiv) { const isHidden = notesDiv.style.display === 'none'; notesDiv.style.display = isHidden ? 'block' : 'none'; target.textContent = isHidden ? 'Mostrar menos' : `Ver ${notesDiv.children.length} mensajes m√°s`; }
                    return;
                }
                
                const calendarDay = target.closest('.calendar-day:not(.other-month)');
                if(calendarDay) {
                    const dateStr = calendarDay.dataset.date, allEvents = Object.values(appData.timelineEvents || {}), events = allEvents.filter(item => item.date === dateStr);
                    const date = new Date(dateStr + 'T12:00:00');
                    let modalContent = '';
                    
                    const weatherStartDate = new Date('2026-01-09T00:00:00'), weatherEndDate = new Date('2026-01-16T23:59:59');
                    if (date >= weatherStartDate && date <= weatherEndDate) {
                        modalContent += getAlgecirasWeatherHTML();
                    }
                    modalContent += `<div class="item-content">${generateDayContentHTML(events, dateStr)}</div>`;

                    document.getElementById('modal-date').innerHTML = `<span>${dayFormatter.format(date)}</span><button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button>`;
                    document.getElementById('modal-events').innerHTML = modalContent;
                    document.getElementById('calendar-modal').classList.add('popup-visible');
                    
                    if (events.length === 0) {
                        // This timeout allows the modal to become visible before the add-item modal potentially covers it.
                        setTimeout(() => {
                            const addButton = document.querySelector('#modal-date .add-button');
                            if(addButton) addButton.click();
                        }, 50);
                    }
                    return;
                }

                const addButton = target.closest('.add-button');
                if(addButton) {
                    const type = addButton.dataset.type, itemDate = addButton.dataset.date || '';
                    const modal = document.getElementById('add-item-modal');
                    modal.querySelector('#add-item-title').innerText = type === 'timelineEvents' ? 'A√±adir Nota al D√≠a' : 'A√±adir Elemento';
                    modal.querySelector('#author-select-container').style.display = type === 'timelineEvents' ? 'block' : 'none';
                    modal.querySelector('form').reset();
                    modal.querySelector('#item-type-input').value = type;
                    modal.querySelector('#item-date-input').value = itemDate;
                    document.getElementById('calendar-modal').classList.remove('popup-visible');
                    modal.classList.add('popup-visible');
                    return;
                }
            });

            document.getElementById('add-item-form').addEventListener('submit', function(e) {
                e.preventDefault(); 
                const type = document.getElementById('item-type-input').value, text = document.getElementById('item-description-input').value, author = document.getElementById('author-select').value;
                if (!type || !text || (type === 'timelineEvents' && !author)) { alert("Por favor, completa todos los campos."); return; }
                const newId = `item-${Date.now()}`;
                if (!appData[type]) appData[type] = {};
                const item = { id: newId, text, timestamp: new Date().toISOString() };
                let eventDateForNotification = null;
                if (type === 'timelineEvents') { 
                    item.date = document.getElementById('item-date-input').value; 
                    item.icon = 'üóíÔ∏è'; item.type = 'note'; item.author = author; 
                    eventDateForNotification = item.date;
                }
                appData[type][newId] = item;
                saveData(author || 'Alguien', eventDateForNotification);
                document.getElementById('add-item-modal').classList.remove('popup-visible');
            });
            
            const privacyPopup = document.getElementById('privacy-popup'); 
            if (new Date() < new Date('2026-01-04T12:00:00')) { privacyPopup.classList.add('popup-visible'); }
        }

        // --- INITIALIZATION ---
        attachStaticListeners(); 
        setInterval(updateCountdowns, 1000);
        setInterval(fetchWeather, 300000);
    });
    </script>
</body>
</html>
