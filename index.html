<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario: Austin a Medell√≠n</title>
    <style>
        /* --- General & Glassmorphism --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap');
        :root {
            --brand-red: #CF4647;
            --brand-blue: #007bff;
            --brand-blue-light: #4facfe;
            --brand-green: #28a745;
            --birthday-color-1: #FF5F6D;
            --birthday-color-2: #FFC371;
            /* Twitter Colors */
            --tw-black: #14171a;
            --tw-gray: #657786;
            --tw-border: #e1e8ed;
        }
        body{
            font-family:'Poppins',sans-serif;
            background-color: #f0f2f5;
            color:#2c3e50;
            margin:0;
            padding:20px; 
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
       
        /* --- Fondo L√°mpara de Lava --- */
        .lava-lamp-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background: linear-gradient(120deg, #e0f2f7 0%, #ebedee 100%); }
        .lava-lamp-background .blob { position: absolute; border-radius: 50%; filter: blur(40px); opacity: 0.6; }
        .blob:nth-child(1) { width: 400px; height: 400px; background: #89CFF0; animation: move 25s infinite alternate; }
        .blob:nth-child(2) { width: 300px; height: 300px; background: #ADD8E6; animation: move 30s infinite alternate-reverse; }
        .blob:nth-child(3) { width: 250px; height: 250px; background: #B0E0E6; animation: move 20s infinite alternate; }
        @keyframes move { from { transform: translate(-100px, -50px) rotate(-90deg); } to { transform: translate(100vw, 50vh) rotate(90deg); } }

        /* --- Login Screen Styles --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 9000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        #login-overlay.hidden { opacity: 0; pointer-events: none; }
        .login-content { 
            display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 40px;
            background: rgba(255, 255, 255, 0.6); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 1);
            max-width: 400px; width: 90%; box-sizing: border-box; 
        }
        .login-content h2 { margin: 0; color: var(--brand-blue); }
        .login-content input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; font-family: 'Poppins', sans-serif; box-sizing: border-box;}
        .login-btn { background-color: var(--brand-blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin-top: 10px;}
        .login-btn:hover { transform: scale(1.02); background-color: #0056b3; }
        #login-error { color: var(--brand-red); font-size: 0.9em; display: none; text-align: center; word-break: break-word;}
        
        .logout-btn { background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; margin-top: 10px; }
        .logout-btn:hover { background: #eee; }

        /* --- Main App Styles --- */
        .container{max-width:800px;margin:0 auto; transition: max-width 0.3s ease, padding 0.3s ease; display: none;} 
        .container.visible { display: block; }
        
        h1,h2,h3{text-align:center;color:#1c2a39}h1{font-size:2.2em;margin-bottom:15px;text-shadow: 0 1px 3px rgba(0,0,0,0.1);}h2{font-size:1.5em;margin:40px 0 20px;color:var(--brand-blue)}
        
        /* Glassmorphism Cards */
        .status-bar, .countdown-card, .item-content, .info-card, .weather-widget, .how-to-banner, .create-post-card {
            background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);
        }

        .status-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;padding:8px 15px;font-size:0.85em;margin-bottom:15px;gap:15px;}
        .live-status{display:flex;align-items:center;gap:8px;font-weight:600;color:#d9534f;}
        .update-details{display:flex;align-items:center;gap:10px;flex-grow:1;justify-content:flex-end;}
        .last-update{color:#333;text-align:right;}
        .notification-chip{color:white;padding:5px 12px;border-radius:16px;font-weight:600;display:flex;align-items:center;gap:5px;white-space:nowrap;}
        .notification-chip.timeline-update { background-color: var(--brand-green); }
        .notification-chip.post-update { background-color: var(--brand-blue); }
        .how-to-banner{padding:15px 20px;margin-bottom:30px;position:relative;display:none;}
        .how-to-banner h4{margin:0 0 10px 0;color:#0d47a1;text-align:left;}
        .how-to-banner p{margin:0 0 10px 0;font-size:0.9em;line-height:1.6;text-align:left;}
        .dismiss-banner-btn{background:none;border:none;color:#555;text-decoration:underline;font-size:0.8em;cursor:pointer;padding:5px;margin-top:5px;display:block;}
        .dismiss-banner-btn:hover{color:#0d47a1;}
        .icon-inline{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle;margin:0 2px;}
        .add-button-demo{background-color:var(--brand-blue);color:white;border-radius:50%;width:18px;height:18px;font-size:14px;font-weight:bold;line-height:18px;text-align:center;}
        
        /* --- Countdown & Animations --- */
        .countdown-container{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-around;gap:15px;margin-bottom:15px}
        .countdown-card{color:#1c2a39;padding:20px;text-align:center;flex:1;min-width:280px;min-height:105px;display:flex;flex-direction:column;justify-content:center; transition: all 0.5s ease;}
        .countdown-card h3{margin-top:0;margin-bottom:10px;font-size:1.1em;font-weight:400;color:var(--brand-blue)}.countdown-card .arrival-date{margin:-5px 0 15px 0;font-size:0.85em;color:#333;opacity:0.9}.timer{display:flex;justify-content:center;gap:15px;font-family:'Roboto Mono',monospace}.time-block{display:flex;flex-direction:column;min-width:55px}.time-block span:first-child{font-size:2.2em;font-weight:700;color:#1c2a39;line-height:1}.time-block span:last-child{font-size:.7em;text-transform:uppercase;color:#555}
        
        /* Pulse Animation */
        @keyframes urgentPulse {
            0% { box-shadow: 0 0 0 0 rgba(207, 70, 71, 0.4); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(207, 70, 71, 0); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(207, 70, 71, 0); transform: scale(1); }
        }
        .urgent-pulse {
            animation: urgentPulse 1.5s infinite;
            border: 2px solid var(--brand-red);
            background-color: rgba(255, 240, 240, 0.3);
        }
        
        /* Progress Bar Styles - BLUE UPDATE */
        .progress-container {
            width: 80%;
            background-color: rgba(200, 200, 200, 0.3);
            border-radius: 10px;
            height: 12px;
            margin: 15px auto 0 auto;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
        }
        .progress-bar {
            height: 100%;
            /* Changed to Blue Gradient */
            background: linear-gradient(90deg, var(--brand-blue-light), var(--brand-blue)); 
            width: 0%;
            transition: width 1s linear;
            border-radius: 10px;
            position: relative;
            /* Changed shadow to blue */
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        /* Animated striping effect */
        .progress-bar::after {
            content: "";
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(45deg,rgba(255,255,255,.25) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.25) 50%,rgba(255,255,255,.25) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }

        .timeline{position:relative;padding:20px 0}.timeline::before{content:'';position:absolute;top:0;left:21px;height:100%;width:4px;background:rgba(255, 255, 255, 0.5)}.timeline-item{padding:10px 20px 10px 65px;position:relative;margin-left:0;margin-bottom:10px}.timeline-item::before{content:attr(data-icon);position:absolute;left:0;top:50%;transform:translateY(-50%);width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.7);border:3px solid var(--brand-blue);text-align:center;line-height:50px;font-size:2.5em; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);}
        .timeline-item.today .item-content { border: 2px solid var(--brand-red); box-shadow: 0 0 15px rgba(207, 70, 71, 0.2); }
        .item-content{padding:15px 20px;}
        .item-date{font-weight:600;color:var(--brand-blue);font-size:1.1em;margin-bottom:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;}.item-date span{flex-grow:1;}.tbd{color:#556;font-style:italic}
        .flight-tracker{border-top:1px solid rgba(255,255,255,0.7);margin-top:15px;padding-top:15px;display:flex;flex-direction:column;gap:10px;align-items:center}
        .flight-tracker h4{margin:0 0 5px 0;font-weight:600;color:#333;display:flex;align-items:center;gap:8px}
        .live-indicator{display:inline-block;width:10px;height:10px;background-color:#ff4d4d;border-radius:50%;animation:blinker 1.5s linear infinite}@keyframes blinker{50%{opacity:0}}.flight-buttons{display:flex;flex-wrap:wrap;gap:15px;justify-content:center}
        .flight-info{display:flex;flex-direction:column;align-items:center}
        .flight-button{display:inline-block;background-color:var(--brand-blue);color:#fff;padding:8px 15px;border-radius:5px;text-decoration:none;font-weight:500;font-size:0.9em;transition:background-color .2s,transform .2s}.flight-button:hover{background-color:#0056b3;transform:translateY(-2px)}
        .flight-route{font-size:0.8em;color:#444;margin-top:4px}
        .info-card{padding:20px;margin-bottom:20px;}
        .info-card h3{margin-top:0;color:var(--brand-blue); display: flex; justify-content: space-between; align-items: center;}.info-card ul{padding-left:0;margin:0; list-style-type: none;}.info-card li{display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.1);}.info-card li:last-child{border-bottom:none;}.info-item-text{flex-grow:1;}
        .weather-widget { padding: 15px 20px; margin-bottom: 15px; }
        .weather-widget h3 { margin: 0 0 15px 0; font-size: 1.2em; color: var(--brand-blue); }
        .weather-locations { display: flex; justify-content: space-around; align-items: center; }
        .weather-location-item { flex: 1; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .weather-city { font-size: 1.1em; font-weight: 600; margin-bottom: 5px; }
        .weather-temp { font-size: 1.3em; font-weight: 600; font-family: 'Roboto Mono', monospace; }
        .weather-time { font-size: 0.9em; color: #333; font-family: 'Roboto Mono', monospace; margin-top: 2px; }
        .weather-divider { width: 1px; background-color: rgba(0,0,0,0.2); align-self: stretch; margin: -5px 10px; }
        
        /* Modal - High Z-Index fix */
        .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(240, 240, 245, 0.5);z-index:20000;display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);}
        .popup-visible{opacity:1!important;visibility:visible!important}
        .popup-content{padding:20px 30px 30px;position:relative;max-width:450px;width:100%;text-align:center;transform:scale(.9);transition:transform .3s; display:flex; flex-direction:column; max-height: 85vh; background: rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(2.9px); -webkit-backdrop-filter: blur(2.9px); border: 1px solid rgba(255, 255, 255, 1);}
        .popup-visible .popup-content{transform:scale(1)}.popup-content h2{margin-top:0;margin-bottom:15px;flex-shrink:0;}.close-popup{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#555;cursor:pointer;transition:color .2s;z-index:10;}.close-popup:hover{color:#000}
        #modal-date{display:flex;justify-content:space-between;align-items:center;width:100%;gap:15px;padding-right:30px;}
        #modal-events{overflow-y:auto; flex-grow:1; text-align:left;}
        .view-switcher{display:flex;justify-content:center;margin-bottom:30px;background:rgba(255,255,255,0.3);border-radius:10px;padding:5px}
        .view-switcher button{border:none;padding:10px 20px;font-family:'Poppins',sans-serif;font-size:1em;font-weight:600;background:transparent;color:#333;border-radius:8px;cursor:pointer;transition:all .3s ease}
        .view-switcher button.active{background:rgba(255,255,255,0.8);color:var(--brand-blue);box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .view-hidden{display:none}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#ccc;border:1px solid #ccc;border-radius:8px;overflow:hidden}
        .calendar-header{font-weight:600;text-align:center;padding:8px 0;font-size:0.9em;background:rgba(255,255,255,0.4)}
        .calendar-day{background:rgba(255,255,255,0.6);min-height:80px;padding:4px;font-size:0.8em;display:flex;flex-direction:column;position:relative}
        .calendar-day:not(.other-month){cursor:pointer;transition:background .2s}.calendar-day:not(.other-month):hover{background:rgba(241, 248, 255, 0.8)}
        .calendar-day.other-month{background:rgba(249, 249, 249, 0.4);color:#aaa}
        .calendar-day.today { border: 2px solid var(--brand-red); background-color: rgba(255, 235, 238, 0.7); }
        .calendar-day.today .day-number { color: var(--brand-red); font-weight: bold; }
        .calendar-day .day-number{font-weight:600;margin-bottom:5px;text-align:right}
        .event-icons-container{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;padding:0 2px;margin-top:4px}
        .calendar-emoji{font-size:1.6em;line-height:1}
        
        /* Items & Messages Styles (Shared between Timeline and Posts) */
        .item-description{padding-bottom:4px;border-bottom:1px solid rgba(0,0,0,0.1);margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;}.item-description:last-child{border-bottom:none;margin-bottom:0;}
        .note-content{flex-grow:1; word-wrap: break-word; word-break: break-word;}.author-name{font-size:0.9em;font-weight:600; display: flex; align-items: center;}
        .item-timestamp{font-size:0.7em; color:#555; white-space:nowrap;}
        .recent-indicator { font-weight: bold; margin-right: 5px; font-size: 0.7em; }
        .recent-indicator.red { color: var(--brand-red); }
        .recent-indicator.green { color: var(--brand-green); }
        #modal-events .item-content{box-shadow:none;padding:10px 0 0 0; background:transparent; border:none; backdrop-filter: none; -webkit-backdrop-filter: none;}
        .modal-close-button{border:none;background:var(--brand-blue);color:#fff;padding:10px 25px;font-size:1em;font-weight:600;border-radius:5px;margin-top:20px;cursor:pointer;transition:background .2s; flex-shrink:0;}.modal-close-button:hover{background:#0056b3}
        .modal-disclaimer{font-size:0.75em; color:#555; margin-top:15px;}
        #add-item-modal .modal-actions { display:flex; gap: 10px; align-items: center; margin-top: 15px;}
        #add-item-modal .modal-actions .modal-close-button { margin-top: 0; flex-grow: 1;}
        
        /* FIX: Make sure buttons are clickable and visible */
        .add-button{background-color:var(--brand-blue);color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:16px;font-weight:bold;line-height:24px;cursor:pointer;transition:all .2s;flex-shrink:0; position: relative; z-index: 5;}.add-button:hover{background-color:#0056b3;transform:scale(1.1)}
        
        #add-item-modal textarea, #add-item-modal select{width:100%;margin-top:10px;padding:10px;border-radius:5px;border:1px solid #ccc;font-family:'Poppins',sans-serif;font-size:1em;box-sizing:border-box}
        #reply-context-container { border: 1px solid rgba(0,0,0,0.1); background: rgba(248, 249, 250, 0.7); border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: left; max-height: 160px; overflow-y: auto; position: relative;}
        #reply-context-container.is-scrollable::after { content: 'Desliza para ver m√°s ‚ñº'; position: sticky; bottom: -10px; display: block; text-align: center; background: linear-gradient(to top, rgba(248, 249, 250, 0.9), rgba(248, 249, 250, 0.9) 70%, transparent); padding-top: 15px; padding-bottom: 10px; font-size: 0.8em; color: #555; font-weight: 600; }
        #reply-context-container h4, #reply-context-container h5 { text-align: left; margin: 0 0 5px 0; font-size: 0.8em; color: #6c757d; text-transform: uppercase; }
        #reply-context-container h5 { margin-top: 10px; }
        .reply-context { border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 8px; }
        .reply-context.original-message { background-color: rgba(233, 236, 239, 0.8); padding: 8px; border-radius: 6px; }
        .reply-context:last-child { border-bottom: none; margin-bottom: 0; }
        .reply-context strong { font-size: 0.9em; }
        .reply-context p { font-size: 0.9em; margin: 4px 0; white-space: pre-wrap; word-wrap: break-word; }
        .reply-context-footer { text-align: right; margin-top: 4px; }
        .reply-context-footer small { font-size: 0.75em; color: #6c757d; display: flex; align-items: center; justify-content: flex-end; }
        .notification-badge{position:absolute;top:4px;left:4px;background-color:#ff4d4d;color:white;border-radius:50%;width:18px;height:18px;font-size:11px;line-height:18px;text-align:center;font-weight:bold;}
        .messages-header{font-weight:600;color:#333;font-size:1em;margin:15px 0 5px 0;padding-top:10px;border-top:1px solid rgba(0,0,0,0.1);display:flex;align-items:center;gap:8px;}
        .toggle-visibility-link { background: none; border: none; padding: 8px; margin: 5px auto; display: block; width: fit-content; color: var(--brand-blue); font-weight: 600; font-size: 0.9em; cursor: pointer; text-decoration: none; }
        .toggle-visibility-link:hover { text-decoration: underline; }
        .toggle-text-btn{font-size:0.8em; font-weight:600; color:var(--brand-blue); text-decoration:none; white-space:nowrap; margin-left:5px;}.toggle-text-btn:hover{text-decoration:underline;}
        .note-footer{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 4px;}
        .reply-btn{background:none; border:none; cursor:pointer; font-size:0.75em; color:#444; padding:2px 6px; border-radius:4px; font-weight:600; display:inline-flex; align-items:center; gap:5px; transition: all 0.2s;}.reply-btn:hover{color:var(--brand-blue); background-color: rgba(255,255,255,0.4);}
        .reply-counter-badge{background-color:var(--brand-green);color:white;border-radius:4px;padding:1px 5px;font-size:11px;font-weight:bold;}
        .replies-container{margin-left:20px; padding-left:15px; border-left:2px solid rgba(233, 236, 239, 0.7); margin-top:8px;}
        .reply-block{background:rgba(248, 249, 250, 0.6); border:1px solid rgba(222, 226, 230, 0.7); border-radius:8px; padding:10px; margin-top:8px;}
        .message-number { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; font-size: 0.75em; font-weight: 600; margin-right: 8px; flex-shrink: 0; }
        .message-number.thread { background-color: var(--brand-red); color: white; }
        .message-number.reply { background-color: var(--brand-green); color: white; }
        .weather-forecast{background: rgba(248, 249, 250, 0.6); border:1px solid rgba(222, 226, 230, 0.7); border-radius:8px;padding:8px 12px;margin-bottom:10px;display:flex;align-items:center;gap:10px;font-size:0.9em;}
        .weather-icon{font-size:1.5em;}
        .ai-badge { display: inline-block; background: linear-gradient(45deg, var(--gemini-purple), #c37ee6); color: white; font-size: 0.7em; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
        
        /* --- Post View Styles (Twitter/X Style) --- */
        .create-post-card { padding: 20px; margin-bottom: 20px; text-align: center; }
        .create-post-card button { width: 100%; padding: 12px; font-size: 1.1em; }
        .posts-container { display: flex; flex-direction: column; gap: 15px; }
        
        /* Twitter-like Card Styles */
        .post-card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: var(--tw-black);
            display: flex; /* Flex layout for Avatar + Content */
            gap: 12px;
            border: 1px solid var(--tw-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .post-left { flex-shrink: 0; }
        .post-right { flex-grow: 1; min-width: 0; /* Crucial for text wrapping in flex children */ }
        
        /* Avatar adjustments */
        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em; /* Emoji size */
            line-height: 1;
        }

        /* Post Header */
        .post-header-row { 
            display: flex; 
            align-items: baseline; 
            gap: 5px; 
            margin-bottom: 4px; 
            flex-wrap: wrap; 
        }
        .post-author-name { font-weight: 700; color: var(--tw-black); font-size: 1em; }
        .post-handle, .post-time { color: var(--tw-gray); font-size: 0.9em; }
        .post-time::before { content: "¬∑"; margin-right: 5px; }

        /* Post Content Body */
        .post-text-body {
            font-size: 1em;
            line-height: 1.4;
            color: var(--tw-black);
            white-space: pre-wrap; /* Preserve newlines */
            word-wrap: break-word; /* Force break long words */
            word-break: break-word; 
            overflow-wrap: break-word;
        }

        /* Post Actions Footer */
        .post-actions-row {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            max-width: 80%;
            color: var(--tw-gray);
            font-size: 1.1em;
        }
        .post-action-btn { cursor: pointer; transition: color 0.2s; display: flex; align-items: center; gap: 5px; font-size: 0.9em;}
        .post-action-btn:hover { color: var(--brand-blue); }
        .post-action-btn.reply-btn { background: none; padding: 0; border: none; color: var(--tw-gray); font-weight: normal;}
        .post-action-btn.reply-btn:hover { background: none; color: var(--brand-blue); }

        /* --- Responsive Styles for Mobile --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8em; }
            .status-bar, .update-details { flex-direction: column; align-items: flex-start; gap: 8px; }
            .update-details { align-items: flex-end; width: 100%; }
            .last-update { font-size: 0.9em; }
            .countdown-container { flex-direction: column; }
            .countdown-card { min-width: 100%; }
            .timeline::before { left: 18px; }
            .timeline-item { padding: 10px 10px 10px 55px; }
            .timeline-item::before { width: 48px; height: 48px; line-height: 42px; font-size: 2em; left: -5px; }
            .item-content { padding: 12px 15px; }
            .popup-content { padding: 20px; max-width: 95%; max-height: 90vh; }
            .view-switcher button { padding: 8px 12px; font-size: 0.9em; }
        }

        /* --- Success Indicator Styles --- */
        #success-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--brand-green);
            font-weight: 600;
            font-size: 1.2em;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            background: rgba(220, 255, 220, 0.8);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 167, 69, 0.4);
        }
        #success-indicator.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .checkmark { width: 56px; height: 56px; border-radius: 50%; display: block; stroke-width: 3; stroke: var(--brand-green); stroke-miterlimit: 10; margin: 0 auto; }
        #success-indicator:not(.hidden) .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-linecap: round; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        #success-indicator:not(.hidden) .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards; }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body>
    <div class="lava-lamp-background">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
    </div>

    <div id="success-indicator" class="hidden">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <span>¬°Guardado!</span>
    </div>

    <div id="login-overlay">
        <div class="login-content">
            <h2>üîê Acceso al Itinerario</h2>
            <p>Ingresa tus credenciales para ver y editar el viaje. NOTA: ROSALINA, FAIBER Y YISELA NO SABEN NADA.</p>
            <input type="email" id="email-input" placeholder="Correo electr√≥nico">
            <input type="password" id="password-input" placeholder="Contrase√±a">
            <button id="login-btn" class="login-btn">Entrar</button>
            <p id="login-error">Error: Verifica tus datos</p>
        </div>
    </div>

    <div id="calendar-modal" class="popup-overlay"><div class="popup-content"><span class="close-popup">&times;</span><h2 id="modal-date"></h2><div id="modal-events"></div><button class="modal-close-button">OK</button></div></div>
   
    <div id="add-item-modal" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup">&times;</span>
            <h2 id="add-item-title">A√±adir Entrada</h2>
            <div id="reply-context-container"></div>
            <form id="add-item-form">
                <input type="hidden" id="item-id-input"><input type="hidden" id="item-type-input"><input type="hidden" id="item-date-input"><input type="hidden" id="reply-to-id-input">
                <div id="author-select-container">
                    <select id="author-select" required>
                        <option value="" disabled selected>¬øQui√©n eres?</option>
                        <option value="Anyela">Anyela</option><option value="Nathan">Nathan</option><option value="Yazmin">Yazmin</option><option value="Ron">Ron</option><option value="Yedinson">Yedinson</option><option value="Daniel">Daniel</option>
                    </select>
                </div>
                <textarea id="item-description-input" placeholder="Escribe tu mensaje o nota aqu√≠..."></textarea>
                 <div class="modal-actions">
                    <button type="submit" class="modal-close-button">Guardar</button>
                </div>
                <p class="modal-disclaimer">Los mensajes no se pueden borrar ni editar.</p>
            </form>
        </div>
    </div>

    <div class="container" id="main-container">
        </div>
    
    <footer>
        Version 090125k_fixed (Final) <br>
        <button id="logout-btn" class="logout-btn">Cerrar Sesi√≥n</button>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
   
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIG & DATA ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrIoHLMIN9XmcTIsTiQQsCUYAKGJut_U8",
          authDomain: "itinerario-viaje-cbf9d.firebaseapp.com",
          databaseURL: "https://itinerario-viaje-cbf9d-default-rtdb.firebaseio.com",
          projectId: "itinerario-viaje-cbf9d",
          storageBucket: "itinerario-viaje-cbf9d.firebasestorage.app",
          messagingSenderId: "88371586960",
          appId: "1:88371586960:web:8b2dd61a4b7d2bed963515"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); // Initialize Auth
        const appDataRef = database.ref('appData');
        let appData = {};
        let currentView = 'timeline';
        const defaultAppData = { lastUpdate: { user: "Sistema", time: new Date().toISOString(), type: 'general' }, timelineEvents: { "event-1":{id:"event-1",date:"2025-12-13",icon:"üõ¨",description:"<strong>PM:</strong> LLegada de Nathan a Medellin desde USA.",type:"flight",flightInfo:{title:"Llegada de Nathan",flights:[{num:"CMP716",route:"Austin ‚Üí Panam√°"},{num:"CMP155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-2":{id:"event-2",date:"2025-12-22",icon:"üè†",description:"Regreso de Nathan a Medellin.",type:"flight",flightInfo:{title:"Regreso de Nathan",flights:[{num:"EFY821",route:"Villavicencio ‚Üí Medell√≠n"}]}},"event-3":{id:"event-3",date:"2025-12-24",icon:"üéÑ",description:"Celebraci√≥n de Nochebuena üéÖ",type:"holiday"},"event-4":{id:"event-4",date:"2025-12-25",icon:"üéÅ",description:"D√≠a de Navidad üåü",type:"holiday"},"event-5":{id:"event-5",date:"2025-12-31",icon:"üéâ",description:"Celebraci√≥n de Fin de A√±o ü•Ç",type:"holiday"},"event-6":{id:"event-6",date:"2026-01-01",icon:"ü•Ç",description:"D√≠a de A√±o Nuevo. Descanso. üéâ",type:"holiday"},"event-7":{id:"event-7",date:"2026-01-03",icon:"üõ¨",description:"<strong>PM:</strong> Llegada de Ron y Anyela a Medell√≠n desde USA.",type:"flight",flightInfo:{title:"Llegada de Ron y Anyela",flights:[{num:"CMP716",route:"Austin ‚Üí Panam√°"},{num:"CMP155",route:"Panam√° ‚Üí Medell√≠n"}]}},"event-8":{id:"event-8",date:"2026-01-04",icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",description:"Primer encuentro familiar. Almuerzo (hora por definir).",type:"celebration"},"event-9":{id:"event-9",date:"2026-01-12",icon:"üéä",description:"D√≠a en Algeciras (D√≠a Festivo üéä). Planes por determinar.",type:"holiday"},"event-10":{id:"event-10",date:"2026-01-15",icon:"üéÇ",description:"<strong>AM:</strong> Llegada - Bus - De la Familia a Medellin.<br><strong>PM:</strong> Salida y llegada - Vuelo - Ron, Anyela y Nathan para Medellin.",type:"travel"},"event-11":{id:"event-11",date:"2026-01-17",icon:"üõ´",description:"<strong>AM:</strong> Salida del resto del grupo desde Medell√≠n a USA. Fin del viaje.",type:"flight",flightInfo:{title:"Vuelos de Regreso",flights:[{num:"CMP209",route:"Medell√≠n ‚Üí Panam√°"},{num:"CMP715",route:"Panam√° ‚Üí Austin"}]}}}, importantNotes: { "note-101":{id:"note-101",text:"<strong>¬°PRIVADO!</strong> Maria Helena, Yedinson, y Yazmin ya saben."},"note-102":{id:"note-102",text:"Faber, Yisela, y Rosita no saben absolutamente nada."} }, plannedActivities: { "activity-201":{id:"activity-201",text:"Bingo"},"activity-202":{id:"activity-202",text:'Regalos con la letra "V" de un valor de $10,000 pesos'},"activity-203":{id:"activity-203",text:"Scavenger Hunt (B√∫squeda del tesoro)"},"activity-204":{id:"activity-204",text:"Pictionary"} }, posts: {} };
       
        // --- AUTH LOGIC ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const mainContainer = document.getElementById('main-container');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');

        // Listen for Auth State Changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                console.log("Usuario conectado:", user.email);
                loginOverlay.classList.add('hidden');
                mainContainer.classList.add('visible');
                
                // Only attach the DB listener IF we are logged in
                appDataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    let loadedData = (data && data.timelineEvents) ? data : JSON.parse(JSON.stringify(defaultAppData));
                    if(!loadedData.posts) loadedData.posts = {}; // Inicializar posts si no existe
                    appData = loadedData;
                    renderApp();
                }, (error) => {
                    console.error("Error leyendo base de datos (posiblemente permiso denegado):", error);
                });

            } else {
                // User is signed out.
                console.log("Usuario desconectado");
                loginOverlay.classList.remove('hidden');
                mainContainer.classList.remove('visible');
                appDataRef.off(); // Detach listener
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.style.display = 'none';
            loginBtn.innerText = 'Verificando...';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in success - onAuthStateChanged will handle the rest
                    loginBtn.innerText = 'Entrar';
                })
                .catch((error) => {
                    console.error(error);
                    loginBtn.innerText = 'Entrar';
                    loginError.innerText = "Error: " + error.message;
                    loginError.style.display = 'block';
                });
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
       
        // --- WIDGETS ---
        function updateCountdowns() {
            const targets = [ { id: 'card-nathan', date: '2025-12-13T18:00:00', title: 'Llegada de Nathan' }, { id: 'card-ron-anyela', date: '2026-01-03T18:00:00', title: 'Llegada de Ron & Anyela' }];
            targets.forEach(target => { 
                const el=document.getElementById(target.id); 
                if(!el) return; 
                const t=new Date(target.date).getTime(), n=new Date().getTime(), d=t-n; 
                
                // Pulse Effect Logic
                const daysLeft = Math.floor(d / (1000 * 60 * 60 * 24));
                if (daysLeft < 13 && daysLeft >= 0) {
                    el.classList.add('urgent-pulse');
                } else {
                    el.classList.remove('urgent-pulse');
                }

                // Charging Bar Logic
                // Start filling from 30 days out. 30 days = 0%, 0 days = 100%
                const maxDays = 30; 
                let percentage = 0;
                if (daysLeft < maxDays) {
                    percentage = 100 - ((daysLeft / maxDays) * 100);
                    if (percentage < 0) percentage = 0;
                    if (percentage > 100) percentage = 100;
                }
                
                let c=`<h3>${target.title}</h3><div class="arrival-date">${formatAndCapitalizeDate(new Date(target.date))}</div>`; 
                if(d<0) c+="<h4>¬°Ya lleg√≥!</h4><div class='progress-container'><div class='progress-bar' style='width:100%'></div></div>"; 
                else {
                    const s=Math.floor(d/864e5),o=Math.floor(d%864e5/36e5),i=Math.floor(d%36e5/6e4),a=Math.floor(d%6e4/1e3);
                    c+=`<div class="timer"><div class="time-block"><span>${String(s).padStart(2,"0")}</span><span>D√≠as</span></div><div class="time-block"><span>${String(o).padStart(2,"0")}</span><span>Horas</span></div><div class="time-block"><span>${String(i).padStart(2,"0")}</span><span>Min</span></div><div class="time-block"><span>${String(a).padStart(2,"0")}</span><span>Seg</span></div></div>`;
                    c+=`<div class="progress-container"><div class="progress-bar" style="width:${percentage}%"></div></div>`;
                } 
                el.innerHTML=c 
            });
        }
       
        async function fetchWeather() {
            const locations = [
                { id: 'weather-austin', city: 'Austin', emoji: 'ü§†', lat: 30.27, lon: -97.74, timezone: 'America/Chicago' },
                { id: 'weather-medellin', city: 'Medell√≠n', emoji: 'üá®üá¥', lat: 6.25, lon: -75.56, timezone: 'America/Bogota' },
                { id: 'weather-algeciras', city: 'Algeciras', emoji: 'üèûÔ∏è', lat: 2.52, lon: -75.31, timezone: 'America/Bogota' }
            ];

            for (const loc of locations) {
                const elements = document.querySelectorAll('#' + loc.id);
                if (elements.length === 0) continue;

                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true`);
                    const data = await res.json();
                    const tempC = Math.round(data.current_weather.temperature);
                    const tempF = Math.round(tempC * 9 / 5 + 32);
                    const localTime = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', timeZone: loc.timezone }).replace('p. m.', 'PM').replace('a. m.', 'AM');
                   
                    elements.forEach(el => {
                        if (loc.id === 'weather-algeciras') {
                            el.innerHTML = `<span class="weather-icon">üå°Ô∏è</span> Clima actual en ${loc.city}: <strong>${tempF}¬∞F / ${tempC}¬∞C</strong>`;
                        } else {
                            el.innerHTML = `<div class="weather-city">${loc.emoji} ${loc.city}</div>
                                            <div class="weather-temp">${tempF}¬∞F / ${tempC}¬∞C</div>
                                            <div class="weather-time">${localTime}</div>`;
                        }
                    });
                } catch (error) {
                    console.error("Weather fetch error for " + loc.city, error);
                    elements.forEach(el => el.innerText = `Error clima ${loc.city}.`);
                }
            }
        }

        // --- DATA & RENDER LOGIC ---
        function saveData(user, itemDate = null, updateType = 'general') {
            if(user) appData.lastUpdate = { user, time: new Date().toISOString(), eventDate: itemDate, type: updateType };
            appDataRef.set(appData); 
        }

        const dayFormatter = new Intl.DateTimeFormat('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
        const formatAndCapitalizeDate = (date) => {
            const formatted = dayFormatter.format(date);
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        };
       
        function handleBannerVisibility() {
            const banner = document.getElementById('how-to-banner');
            if (banner && localStorage.getItem('itineraryBannerDismissed') !== 'true') {
                banner.style.display = 'block';
            }
        }

        function truncateText(html, charLimit = 150) {
            html = html || '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const textContent = tempDiv.textContent || tempDiv.innerText || "";

            if (textContent.length <= charLimit) {
                return html;
            }
            const visibleText = html.substring(0, charLimit);
            const hiddenText = html.substring(charLimit);
            return `<span>${visibleText}</span><span class="ellipsis">... </span><span class="more-text" style="display:none;">${hiddenText}</span> <a href="#" class="toggle-text-btn">Ver m√°s</a>`;
        }

        // --- AVATARES PERSONALIZADOS ---
        const AVATARS = {
            "Anyela": "üë©üèª‚Äçü¶±",
            "Nathan": "üë¶üèª",
            "Yazmin": "üë©üèª",
            "Ron": "üë®üèª",
            "Yedinson": "üßîüèª‚Äç‚ôÇÔ∏è",
            "Daniel": "üßëüèª",
            "Gemini": "‚ú®"
        };

        const getAvatar = (name) => {
            return AVATARS[name] || "üë§"; // Retorna el avatar o uno por defecto
        };
        
        const generateColor = (name) => {
            if (name === 'Gemini') return 'var(--gemini-purple)';
            let hash = 0;
            if (!name || name.length === 0) return '#007bff'; // Default blue
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const AVATAR_COLORS = ['#E53935', '#D81B60', '#5E35B1', '#3949AB', '#1E88E5', '#039BE5', '#00ACC1', '#00897B', '#43A047', '#7CB342', '#F4511E', '#795548', '#546E7A'];
            const index = Math.abs(hash) % AVATAR_COLORS.length;
            return AVATAR_COLORS[index];
        };
       
        function renderApp() {
            document.getElementById('main-container').innerHTML = getBaseHTML();
            renderTimeline(); 
            renderCalendar(); 
            renderPosts(); // Renderiza la nueva secci√≥n de Posts
            renderInfoLists();
            attachStaticListeners();
            attachDynamicListeners();
            updateHeader();
            updateCountdowns();
            fetchWeather();
            handleBannerVisibility();
           
            if (currentView === 'chat') currentView = 'posts'; // Redirigir chat antiguo a posts
            switchView(currentView, true);
        }

        function renderMessageThreadsListHTML(messages, options = {}) {
            if (messages.length === 0) return '';
            const notesById = {};
            messages.forEach(note => { notesById[note.id] = { ...note, replies: [] }; });
            const allMessageThreads = [];
            messages.forEach(note => {
                if (note.replyingTo && notesById[note.replyingTo]) {
                    notesById[note.replyingTo].replies.push(notesById[note.id]);
                } else {
                    allMessageThreads.push(notesById[note.id]);
                }
            });
           
            const threadsOldestFirst = [...allMessageThreads].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            const threadNumberMap = new Map(threadsOldestFirst.map((thread, index) => [thread.id, index + 1]));

            // Ordenar hilos m√°s recientes primero para Posts, cronol√≥gico para notas del d√≠a (opcional, aqu√≠ usaremos reciente primero)
            const messageThreads = allMessageThreads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
           
            let html = '';
            
            // Check if we are rendering Posts (Twitter Style) or standard messages
            if (options.dataType === 'posts') {
                const collapseAfter = options.collapseAfter || 10;
                // Custom loop for Twitter Style
                messageThreads.slice(0, collapseAfter).forEach(thread => {
                    html += renderTwitterPost(thread, { ...options });
                });
                
                if (messageThreads.length > collapseAfter) {
                    // Logic for hidden posts could go here if needed, simplified for now
                }
            } else {
                // Standard Logic for Notes
                const collapseAfter = options.collapseAfter || 10;
                const renderAndTrack = (threads) => {
                    let tempHtml = '';
                    threads.forEach(thread => {
                        tempHtml += renderSingleThread(thread, threadNumberMap.get(thread.id), { ...options });
                    });
                    return tempHtml;
                };
                html += renderAndTrack(messageThreads.slice(0, collapseAfter));
                if (messageThreads.length > collapseAfter) {
                    let hiddenHtml = renderAndTrack(messageThreads.slice(collapseAfter));
                    html += `<div class="collapsible-messages" style="display:none;">${hiddenHtml}</div>`;
                    html += `<button class="toggle-visibility-link" data-count="${messageThreads.length - collapseAfter}">Ver ${messageThreads.length - collapseAfter} mensajes anteriores</button>`;
                }
            }
            return html;
        }

        // New function to render a single Twitter-style post
        function renderTwitterPost(post, options) {
            const avatar = getAvatar(post.author);
            const avatarColor = generateColor(post.author);
            const handle = `@${post.author.toLowerCase().replace(/\s+/g, '_')}`;
            const date = new Date(post.timestamp).toLocaleString('es-CO', { day: 'numeric', month: 'short' });
            
            const replyCounter = post.replies && post.replies.length > 0 ? ` ${post.replies.length}` : '';

            let repliesHtml = '';
            if (post.replies.length > 0) {
                const repliesNewestFirst = [...post.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                repliesHtml = `<div class="replies-container" style="border-left: 2px solid var(--tw-border); margin-left: 24px; padding-left: 15px; margin-top: 10px;">`;
                repliesNewestFirst.forEach(reply => {
                    const rHandle = `@${reply.author.toLowerCase().replace(/\s+/g, '_')}`;
                    repliesHtml += `
                        <div style="margin-bottom: 8px; font-size: 0.9em;">
                            <strong>${reply.author}</strong> <span style="color:var(--tw-gray)">${rHandle}</span>
                            <div style="margin-top:2px;">${reply.text}</div>
                        </div>
                    `;
                });
                repliesHtml += `</div>`;
            }

            return `
            <div class="post-card">
                <div class="post-left">
                    <div class="post-avatar" style="background-color: ${avatarColor}; color: white;">${avatar}</div>
                </div>
                <div class="post-right">
                    <div class="post-header-row">
                        <span class="post-author-name">${post.author}</span>
                        <span class="post-handle">${handle}</span>
                        <span class="post-time">${date}</span>
                    </div>
                    <div class="post-text-body">${post.text}</div>
                    
                    <div class="post-actions-row">
                        <button class="post-action-btn reply-btn" data-type="posts" data-reply-to-id="${post.id}">
                            üí¨${replyCounter || ''}
                        </button>
                        <span class="post-action-btn">üîÅ</span>
                        <span class="post-action-btn">‚ù§Ô∏è</span>
                        <span class="post-action-btn">üì§</span>
                    </div>
                    ${repliesHtml}
                </div>
            </div>`;
        }

        function renderSingleThread(thread, threadNumber, options) {
            let mostRecentInThreadId = null;
            if (thread.replies.length > 0) {
                const latestReply = [...thread.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                mostRecentInThreadId = latestReply.id;
            }
            options.mostRecentInThreadId = mostRecentInThreadId;

            let threadHtml = renderMessage(thread, threadNumber, false, options);
            if (thread.replies.length > 0) {
                threadHtml += `<h4 class="messages-header" style="margin-top: 10px; padding-top: 10px; font-size: 0.9em;">Comentarios:</h4>`;
                threadHtml += `<div class="replies-container">`;
                const repliesNewestFirst = [...thread.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // Nuevos comentarios arriba en el hilo

                repliesNewestFirst.forEach((reply) => { 
                    threadHtml += renderMessage(reply, 0, true, { ...options });
                });
                threadHtml += `</div>`;
            }
            threadHtml += `</div>`;
            return threadHtml;
        }

        function renderMessage(note, number, isReply, options = {}) {
            const numberClass = isReply ? 'reply' : 'thread';
            // Usamos el avatar en lugar del n√∫mero si es un post principal, o junto al nombre
            const avatarHtml = `<span class="avatar-img">${getAvatar(note.author)}</span>`;
            const authorHtml = `<strong class="author-name">${avatarHtml} ${note.author}:</strong>`;
           
            let nuevoIndicator = '';
            if (note.id === options.mostRecentId && !isReply) {
                nuevoIndicator = `<strong class="recent-indicator red">NUEVO</strong>`;
            } else if (isReply && note.id === options.mostRecentInThreadId) {
                nuevoIndicator = `<strong class="recent-indicator green">M√ÅS RECIENTE</strong>`;
            }
           
            const timestampHtml = `<span class="item-timestamp">${nuevoIndicator} ${new Date(note.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit', timeZone: 'America/Bogota'}).replace('.', '')} COL</span>`;
            const replyCounter = !isReply && note.replies && note.replies.length > 0 ? `<span class="reply-counter-badge">${note.replies.length}</span>` : '';
            let footerHtml = `<div class="note-footer">${timestampHtml}`;
            if(!isReply) {
                footerHtml += `<button class="reply-btn" data-type="${options.dataType}" data-reply-to-id="${note.id}" ${note.date ? `data-date="${note.date}"` : ''}>Responder${replyCounter}</button>`;
            }
            footerHtml += `</div>`;
           
            const authorLine = `<div class="author-name">${authorHtml}</div>`;
            const messageContent = `<div class="note-content">${authorLine}${truncateText(note.text)}${footerHtml}</div>`;

            if(isReply) {
                return `<div class="reply-block">${messageContent}</div>`;
            } else {
                return `<div class="item-content"><div class="item-description">${messageContent}</div>`;
            }
        }
       
        function getBirthdayHTML() {
            return `<div class="birthday-banner">üéâüéÇ ¬°Feliz Cumplea√±os, Faiber! üéàü•≥</div>`;
        }
       
        function getEventDateRange() {
            const allEvents = Object.values(appData.timelineEvents || {});
            const dates = allEvents.map(e => e.date).filter(Boolean);
            if (dates.length === 0) {
                const today = new Date();
                return { start: today, end: today };
            }
            dates.sort();
            const minDate = new Date(dates[0] + 'T12:00:00');
            const maxDate = new Date(dates[dates.length - 1] + 'T12:00:00');
            return { start: minDate, end: maxDate };
        }

        function generateDayContentHTML(dateStr) {
            const allEvents = Object.values(appData.timelineEvents || {});
            const events = allEvents.filter(item => item.date === dateStr);
            let html = '';

            if(dateStr === '2026-01-15') {
                html += getBirthdayHTML();
            }
           
            const weatherStartDate = new Date('2026-01-09T00:00:00');
            const weatherEndDate = new Date('2026-01-16T23:59:59');
            const currentDate = new Date(dateStr + 'T12:00:00');
            if (currentDate >= weatherStartDate && currentDate <= weatherEndDate) {
                html += `<div class="weather-forecast" id="weather-algeciras">Cargando clima de Algeciras...</div>`;
            }
           
            const planEvents = events.filter(e => e.type !== 'note');
            const noteEvents = events.filter(e => e.type === 'note');
            if (planEvents.length > 0) {
                planEvents.forEach(item => { 
                    const aiBadge = item.aiGenerated ? '<span class="ai-badge">‚ú® IA</span>' : '';
                    html += `<div class="item-description">${item.description}${aiBadge}</div>`; 
                    if (item.flightInfo) { const buttons = item.flightInfo.flights.map(f => `<div class="flight-info"><a href="https://es.flightaware.com/live/flight/${f.num.replace(/\d/g,'')}${f.num.replace(/\D/g,'')}" target="_blank" class="flight-button">‚úàÔ∏è Ver Vuelo ${f.num}</a><span class="flight-route">${f.route}</span></div>`).join(''); html += `<div class="flight-tracker"><h4><span class="live-indicator"></span>Seguimiento en Vivo:</h4><div class="flight-buttons">${buttons}</div></div>`; } });
            } else if (noteEvents.length === 0 && dateStr !== '2026-01-15') {
                html += `<div class="item-description tbd">No hay planes para este d√≠a.</div>`;
            }
            if(noteEvents.length > 0) {
                const mostRecentNote = noteEvents.reduce((latest, current) => new Date(current.timestamp) > new Date(latest.timestamp) ? current : latest);
                html += `<h4 class="messages-header">Notas del D√≠a</h4>`;
                html += renderMessageThreadsListHTML(noteEvents, { dataType: 'timelineEvents', collapseAfter: 3, mostRecentId: mostRecentNote.id });
            }
            return html;
        }

        function renderTimeline() {
            const timelineView = document.getElementById('timeline-view');
            const allEvents = Object.values(appData.timelineEvents || {});
            let html = '', currentMonth = -1;
            const monthFormatter = new Intl.DateTimeFormat('es-CO', { month: 'long', year: 'numeric' });
           
            const { start: startDate, end: endDate } = getEventDateRange();
            if (!startDate) return;
            endDate.setDate(endDate.getDate() + 1);
           
            const todayStr = new Date().toISOString().split('T')[0];

            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const events = allEvents.filter(item => item.date === dateStr);
                const monthName = monthFormatter.format(d).replace(/(\b[a-z](?=[a-z]{2}))/g, letter => letter.toUpperCase());
                if (d.getMonth() !== currentMonth) { 
                    currentMonth = d.getMonth(); 
                    html += `<h2>${monthName}</h2>`; 
                }
                const dayIcon = events.find(e => e.type !== 'note')?.icon || 'üóìÔ∏è';
                const todayClass = dateStr === todayStr ? 'today' : '';
                html += `<div class="timeline-item ${todayClass}" data-icon="${dayIcon}"><div class="item-content"><div class="item-date"><span>${formatAndCapitalizeDate(d)}</span><button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button></div>`;
                html += generateDayContentHTML(dateStr);
                html += `</div></div>`;
            }
            timelineView.innerHTML = html;
        }

        function renderCalendar() {
            const calendarView = document.getElementById('calendar-view'), allEvents = Object.values(appData.timelineEvents || {});
            calendarView.innerHTML = '';
           
            const { start: calStartDate, end: calEndDate } = getEventDateRange();
            if (!calStartDate) return;
            const monthsToRender = [];
            let loopDate = new Date(calStartDate.getFullYear(), calStartDate.getMonth(), 1);
            while (loopDate <= calEndDate) {
                monthsToRender.push({ y: loopDate.getFullYear(), m: loopDate.getMonth() });
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
           
            const todayStr = new Date().toISOString().split('T')[0];

            monthsToRender.forEach(cal => {
                const year = cal.y, month = cal.m;
                const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                let html = `<h3>${monthNames[month]} ${year}</h3><div class="calendar-grid">`;
                const dayNames = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
                dayNames.forEach(day => { html += `<div class="calendar-header">${day}</div>`; });
                const firstDay = new Date(year, month).getDay();
                for (let i = 0; i < firstDay; i++) { html += '<div class="calendar-day other-month"></div>'; }
                const daysInMonth = 32 - new Date(year, month, 32).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = allEvents.filter(item => item.date === dateStr);
                    const noteCount = events.filter(item => item.type === 'note' && !item.replyingTo).length;
                   
                    let dayClass = 'calendar-day';
                    if (dateStr === todayStr) dayClass += ' today';
                    if (dateStr === '2026-01-15') dayClass += ' birthday-date';

                    let dayContent = '';
                    if (events.length > 0) {
                        dayContent = `<div class="event-icons-container"><span class="calendar-emoji">${events.find(e=>e.type!=="note")?.icon||"üóíÔ∏è"}</span></div>`;
                    }

                    const badge = noteCount > 0 ? `<div class="notification-badge">${noteCount}</div>` : '';
                    html += `<div class="${dayClass}" data-date="${dateStr}"><div class="day-number">${day}</div>${dayContent}${badge}</div>`;
                }
                html += '</div>'; calendarView.innerHTML += html;
            });
        }

        // --- Renderizar Publicaciones (Estilo Twitter) ---
        function renderPosts() {
            const postsView = document.getElementById('posts-view');
            const allPosts = Object.values(appData.posts || []);
            
            // Header: Crear Publicaci√≥n
            let html = `
                <div class="create-post-card">
                    <h3>üì¢ Publicaciones Familiares</h3>
                    <button class="add-button" data-type="posts" style="width:auto; border-radius:8px; padding: 10px 20px; font-size:1em;">+ Nueva Publicaci√≥n</button>
                </div>
            `;

            if (allPosts.length === 0) {
                html += `<div class="item-content tbd" style="text-align:center; padding: 20px;">No hay publicaciones. ¬°S√© el primero en compartir algo!</div>`;
            } else {
                html += `<div class="posts-container">`;
                // Usamos dataType: 'posts' para activar el renderizado estilo Twitter
                html += renderMessageThreadsListHTML(allPosts, { dataType: 'posts', collapseAfter: 15 });
                html += `</div>`;
            }
            
            postsView.innerHTML = html;
        }
       
        function renderInfoLists() {
            ['importantNotes', 'plannedActivities'].forEach(type => {
                const list = document.getElementById(type === 'importantNotes' ? 'important-notes-list' : 'planned-activities-list');
                const items = Object.values(appData[type] || {});
                items.sort((a,b) => (b.timestamp && a.timestamp) ? new Date(b.timestamp) - new Date(a.timestamp) : 0);
                list.innerHTML = items.map(item => {
                    const aiBadge = item.aiGenerated ? '<span class="ai-badge">‚ú® IA</span>' : '';
                    return `<li><div class="info-item-text">${truncateText(item.text)}${aiBadge}</div></li>`;
                }).join("");
            });
        }
       
        function updateHeader() {
            const updateDetailsContainer = document.getElementById('update-details');
            if (!updateDetailsContainer || !appData.lastUpdate) return;
           
            const { user, time, eventDate, type } = appData.lastUpdate;
            if(!time) { updateDetailsContainer.innerHTML = ''; return; }
           
            const updateTimestamp = new Date(time).toLocaleString('es-CO', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: 'America/Bogota' });
            const lastUpdateHtml = `<div class="last-update">Actualizado por <strong>${user}</strong> ‚Ä¢ ${updateTimestamp}</div>`;
           
            let notificationHtml = '';
            const timeSinceUpdate = new Date() - new Date(time);

            if (user !== 'Sistema' && timeSinceUpdate < 600000) { // 10 minute window
                let locationText = '';
                let chipClass = '';
                if(type === 'posts') {
                    locationText = ' en Publicaciones';
                    chipClass = 'post-update';
                } else if (type === 'ai_update') {
                    locationText = ' por IA';
                    chipClass = 'ai-update';
                } else if (type === 'timeline' && eventDate) {
                    const dateObj = new Date(eventDate + 'T12:00:00');
                    const notificationDate = dateObj.toLocaleDateString('es-CO', { month: 'short', day: 'numeric', timeZone: 'America/Bogota' });
                    locationText = ` en: ${notificationDate}`;
                    chipClass = 'timeline-update';
                }
                notificationHtml = `<div class="notification-chip ${chipClass}">üîî Novedad${locationText}</div>`;
            }
            updateDetailsContainer.innerHTML = notificationHtml + lastUpdateHtml;
        }

        function getBaseHTML() { 
            return `<h1>ü§† De Austin a Medell√≠n üá®üá¥</h1>
                        <div class="status-bar" id="status-bar">
                            <div class="live-status"><span class="live-indicator"></span>En vivo</div>
                            <div class="update-details" id="update-details"></div>
                        </div>
                        <div class="how-to-banner" id="how-to-banner"><h4>¬øC√≥mo usar?</h4><p>Este es un itinerario en vivo. Aqu√≠ podr√°s seguir el conteo regresivo, ver informacion importante del itinerario, y ver las publicaciones familiares. Todas las horas estan en hora Colombiana.</p><button class="dismiss-banner-btn"> (x) No volver a mostrar</button></div>
                        <div class="countdown-container"><div class="countdown-card" id="card-nathan">Cargando...</div><div class="countdown-card" id="card-ron-anyela">Cargando...</div></div>
                        <div class="weather-widget">
                            <h3>Clima Actual</h3>
                            <div class="weather-locations">
                                <div id="weather-austin" class="weather-location-item">Cargando...</div>
                                <div class="weather-divider"></div>
                                <div id="weather-medellin" class="weather-location-item">Cargando...</div>
                            </div>
                        </div>
                        <div class="view-switcher"><button id="show-timeline" class="active">L√≠nea de Tiempo</button><button id="show-posts">Publicaciones</button><button id="show-calendar">Calendario</button></div>
                        <div class="timeline" id="timeline-view"></div>
                        <div id="posts-view" class="view-hidden"></div>
                        <div id="calendar-view" class="view-hidden"></div>
                        <div class="info-cards-container"><h2>Informaci√≥n Adicional</h2><div class="info-card"><h3>üìù Notas Importantes <button class="add-button" data-type="importantNotes">+</button></h3><ul id="important-notes-list"></ul></div><div class="info-card"><h3>üé≤ Actividades Planeadas <button class="add-button" data-type="plannedActivities">+</button></h3><ul id="planned-activities-list"></ul></div></div>`; 
        }
       
        function showSuccessIndicator(message = '¬°Guardado!', isError = false) {
            const indicator = document.getElementById('success-indicator');
            const checkmark = indicator.querySelector('.checkmark');
            if (indicator) {
                indicator.querySelector('span').innerText = message;
                checkmark.style.display = isError ? 'none' : 'block';
                indicator.style.color = isError ? 'var(--brand-red)' : 'var(--brand-green)';
                indicator.style.background = isError ? 'rgba(255, 220, 220, 0.6)' : 'rgba(220, 255, 220, 0.6)';
                indicator.classList.remove('hidden');
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 4000);
            }
        }
       
        function attachDynamicListeners() {
            const views = { timeline: document.getElementById('timeline-view'), calendar: document.getElementById('calendar-view'), posts: document.getElementById('posts-view') };
            document.getElementById('show-timeline').addEventListener('click', () => switchView('timeline'));
            document.getElementById('show-calendar').addEventListener('click', () => switchView('calendar'));
            document.getElementById('show-posts').addEventListener('click', () => switchView('posts'));
           
            window.switchView = function(activeView, isInitialLoad = false) {
                currentView = activeView;

                Object.keys(views).forEach(key => {
                    const button = document.getElementById(`show-${key}`);
                    if (button) {
                        if (key === activeView) {
                            button.classList.add('active');
                            if(views[key]) views[key].classList.remove('view-hidden');
                        } else {
                            button.classList.remove('active');
                            if(views[key]) views[key].classList.add('view-hidden');
                        }
                    }
                });
            }
        }
       
        function openModal(options) {
            const modal = document.getElementById('add-item-modal');
            const contextContainer = document.getElementById('reply-context-container');
            contextContainer.innerHTML = '';
            contextContainer.classList.remove('is-scrollable');
            contextContainer.style.display = 'none';

            if (options.originalMessage) {
                contextContainer.style.display = 'block';
                let contextHTML = `<h4>Respondiendo a:</h4>
                <div class="reply-context original-message">
                    <strong>${getAvatar(options.originalMessage.author)} ${options.originalMessage.author}</strong> <small>${new Date(options.originalMessage.timestamp).toLocaleString('es-CO', {timeZone: 'America/Bogota'})}</small>
                    <p>${options.originalMessage.text}</p>
                </div>`;
               
                if (options.replies && options.replies.length > 0) {
                    const repliesNewestFirst = [...options.replies].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                   
                    let repliesHtml = '<h5>Respuestas Anteriores:</h5>';
                   
                    repliesNewestFirst.forEach((reply, index) => {
                        const nuevoIndicator = (index === 0) ? `<strong class="recent-indicator green">M√ÅS RECIENTE</strong>` : '';
                        const timestampHtml = `<small>${nuevoIndicator} ${new Date(reply.timestamp).toLocaleString('es-CO',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit', timeZone: 'America/Bogota'}).replace('.', '')}</small>`;

                        repliesHtml += `
                            <div class="reply-context">
                                <div class="author-name">${getAvatar(reply.author)} <strong>${reply.author}</strong></div>
                                <p>${reply.text}</p>
                                <div class="reply-context-footer">${timestampHtml}</div>
                            </div>`;
                    });
                    contextHTML += repliesHtml;
                }
                contextContainer.innerHTML = contextHTML;
               
                setTimeout(() => {
                    if (contextContainer.scrollHeight > contextContainer.clientHeight) {
                        contextContainer.classList.add('is-scrollable');
                    }
                }, 0);
            }

            modal.querySelector('#add-item-title').innerText = options.title;
            modal.querySelector('form').reset();
            modal.querySelector('#item-type-input').value = options.type;
            modal.querySelector('#item-date-input').value = options.date || '';
            modal.querySelector('#reply-to-id-input').value = options.replyToId || '';
            const savedAuthor = localStorage.getItem('itineraryAuthor');
            if (savedAuthor) {
                modal.querySelector('#author-select').value = savedAuthor;
            }
            document.getElementById('calendar-modal').classList.remove('popup-visible');
            modal.classList.add('popup-visible');
        }
       
        function attachStaticListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('#enter-button')) { const overlay = document.getElementById('pre-screen-overlay'); if (overlay) { overlay.classList.add('hidden'); setTimeout(() => { overlay.style.display = 'none'; }, 700); } return; }
                if (target.matches('.dismiss-banner-btn')) { const banner = target.closest('.how-to-banner'); if(banner) banner.style.display = 'none'; localStorage.setItem('itineraryBannerDismissed', 'true'); return; }
                if (target.matches('.toggle-text-btn')) { 
                    e.preventDefault();
                    const parent = target.parentElement;
                    const ellipsis = parent.querySelector('.ellipsis');
                    const moreText = parent.querySelector('.more-text');
                    const isHidden = moreText.style.display === 'none';
                   
                    ellipsis.style.display = isHidden ? 'none' : 'inline';
                    moreText.style.display = isHidden ? 'inline' : 'none';
                    target.textContent = isHidden ? 'Ver menos' : 'Ver m√°s';
                    return;
                }
               
                if (target.matches('.toggle-visibility-link')) {
                    const hiddenContent = target.previousElementSibling;
                    const isHidden = hiddenContent.style.display === 'none' || hiddenContent.style.display === '';
                    if (isHidden) {
                        hiddenContent.style.display = 'block';
                        target.textContent = 'Ocultar mensajes anteriores';
                    } else {
                        hiddenContent.style.display = 'none';
                        const count = target.dataset.count;
                        target.textContent = `Ver ${count} mensajes anteriores`;
                    }
                    return;
                }
               
                const popup = target.closest('.popup-overlay');
                if (popup && (target === popup || target.matches('.close-popup') || target.matches('.modal-close-button'))) { 
                    popup.classList.remove('popup-visible'); 
                    return; 
                }
               
                const calendarDay = target.closest('.calendar-day:not(.other-month)');
                if(calendarDay) {
                    const dateStr = calendarDay.dataset.date;
                    const date = new Date(dateStr + 'T12:00:00');
                    document.getElementById('modal-date').innerHTML = `<span>${formatAndCapitalizeDate(date)}</span><button class="add-button" data-type="timelineEvents" data-date="${dateStr}">+</button>`;
                    document.getElementById('modal-events').innerHTML = `<div class="item-content">${generateDayContentHTML(dateStr)}</div>`;
                    document.getElementById('calendar-modal').classList.add('popup-visible');
                    fetchWeather();
                    const allEvents = Object.values(appData.timelineEvents || {});
                    const eventsOnDay = allEvents.filter(item => item.date === dateStr);
                    if (eventsOnDay.length === 0 && dateStr !== '2026-01-15') { 
                        setTimeout(() => { 
                            const addButton = document.querySelector('#modal-date .add-button'); 
                            if(addButton) addButton.click(); 
                        }, 50); 
                    }
                    return;
                }
                const replyButton = target.closest('.reply-btn');
                if(replyButton) {
                    const type = replyButton.dataset.type;
                    const replyToId = replyButton.dataset.replyToId;
                    const date = replyButton.dataset.date || '';
                    
                    const pool = (type === 'posts') ? Object.values(appData.posts || {}) : Object.values(appData.timelineEvents || {});
                    const originalMessage = pool.find(m => m.id === replyToId);

                    if (originalMessage) {
                        let replies = [];
                        if (type === 'posts') {
                             replies = pool.filter(m => m.replyingTo === replyToId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                        } else if(type === 'timelineEvents') {
                            replies = pool.filter(m => m.replyingTo === replyToId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                        }
                        openModal({ 
                            title: `Responder a ${originalMessage.author}`, 
                            type: type, 
                            date: date, 
                            replyToId: replyToId,
                            originalMessage: originalMessage,
                            replies: replies
                        });
                    }
                    return;
                }
                const addButton = target.closest('.add-button');
                if(addButton) {
                    const type = addButton.dataset.type;
                    if (type === 'posts') {
                         openModal({ title: 'Nueva Publicaci√≥n', type: type });
                         return;
                    }
                    const itemDate = addButton.dataset.date || '';
                    let title = type === 'importantNotes' ? 'A√±adir Nota Importante' : 
                                type === 'plannedActivities' ? 'A√±adir Actividad' : 'A√±adir Nota';
                    openModal({ title: title, type: type, date: itemDate });
                    return;
                }
            });

            document.body.addEventListener('submit', function(e) {
                if (e.target.id === 'add-item-form') {
                    e.preventDefault(); 
                    const type = document.getElementById('item-type-input').value;
                    const text = document.getElementById('item-description-input').value.trim();
                    const author = document.getElementById('author-select').value;
                    if (!type || !text || !author) { alert("Por favor, completa todos los campos."); return; }
                    localStorage.setItem('itineraryAuthor', author);
                   
                    const newId = `${type.slice(0,4)}-${Date.now()}`;
                    if (!appData[type]) appData[type] = {};
                   
                    const item = { id: newId, text, author, timestamp: new Date().toISOString() };
                    const replyingToId = document.getElementById('reply-to-id-input').value;
                    if(replyingToId) item.replyingTo = replyingToId;
                   
                    let notificationType = 'general';
                    let eventDateForNotification = null;

                    if (type === 'timelineEvents') { 
                        item.date = document.getElementById('item-date-input').value; 
                        item.icon = 'üóíÔ∏è'; 
                        item.type = 'note'; 
                        eventDateForNotification = item.date;
                        notificationType = 'timeline';
                    } else if (type === 'posts') {
                        notificationType = 'posts';
                    }
                   
                    appData[type][newId] = item;
                    saveData(author, eventDateForNotification, notificationType);
                   
                    document.getElementById('add-item-modal').classList.remove('popup-visible');
                    showSuccessIndicator();
                }
            });
        }

        // --- INITIALIZATION ---
        setInterval(updateCountdowns, 1000);
        setInterval(fetchWeather, 300000);
    });
    </script>
</body>
</html>
